<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/favicon.ico">

    <title>KumNum Publishing Online Report</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Tabulator CSS-->
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/overlay.css" rel="stylesheet">
    <link href="css/dashboard.css" rel="stylesheet">
    <link href="css/pricing.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
  </head>

  <body>
    <div class="overlay" id="overlay"></div>

    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">ร้านหนังสือ "คำนำ"</a>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column" id="menu-sidebar">
              <!-- Dynamically load sidebar menu item -->
            </ul>
            <hr>
            <ul class="nav flex-column mb-2">
              <li class="nav-item">
                <a class="nav-link" href="#" id="menu-website" target="_blank">
                  <i class="fa fa-globe fa-lg"></i>&nbsp;&nbsp;เวบไซต์
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
          <div id="panel-content">
            <h3 id="panel-header"></h3>
            <p id="panel-description"></p>
          </div>
        </main>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-slim.min.js"><\/script>')</script>
    <!-- <script src="js/popper.min.js"></script> -->
    <!-- <script src="js/holder.min.js"></script> -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>

    <!-- Font Awesome Kit Code -->
    <script src="https://kit.fontawesome.com/354ed2e7c0.js" crossorigin="anonymous"></script>

    <!-- Tabulator JS -->
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

    <!-- manUtils JavaScript -->
    <script src="js/manutils.js"></script>

    <!-- Dashboard JavaScript -->
    <script type="text/javascript">
      var sheetURL = 'https://sheet.best/api/sheets/5acb1568-5ff2-4717-81dc-23a4093f6cbc';
      var menuId = (manUtils.getParam('id') == null || manUtils.getParam('id') == "") ? 'main-dashboard' : manUtils.getParam('id');
      var key = manUtils.getParam('key');
      var globalVars = null;
      var arrPublisher = null;
      var arrPayments = null;
      var arrContacts = null;
      var arrProducts = null;
      var arrOrders = null;
      var arrSales = null;

      function init() {

        showSidebarMenu(menuId);

        // Show Panel Content
        var iPanel = document.getElementById('panel-content');
        switch (menuId) {
          case 'main-dashboard': loadPublisher(iPanel); break;
          case 'main-contact': loadContacts(iPanel); break;
          case 'main-book': loadProducts(iPanel); break;
          case 'main-order': loadOrders(iPanel); break;
          case 'main-sale': loadSales(iPanel); break;
          default:
        }
        document.getElementById('overlay').remove();
      }

      function loadPublisher(iPanel) {
        // GET Author Info
        fetch(sheetURL + '/tabs/Publisher')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrPublisher = myJson;

          loadPayments(iPanel)
        })
        .catch((error) => { console.log(error); });
      }

      function loadPayments(iPanel) {
        // GET Author Info
        fetch(sheetURL + '/tabs/Payments')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrPayments = myJson;

          showDashboard(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      function loadContacts(iPanel) {
        // GET Author Info
        fetch(sheetURL + '/tabs/Contacts')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrContacts = myJson;

          showContacts(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      function loadProducts(iPanel) {
        var fetchUrl = sheetURL + '/tabs/Products';
        //if (contactId) fetchUrl += '/ContactId/*' + contactId + '*';
        //if (true) fetchUrl += '/Highlight/*True*'; // {DebugPoint}
        //if (manUtils.getParam('book')) fetchUrl += '/ProductId/*' + manUtils.getParam('book') + '*'; // {DebugPoint}

        // GET Author's Collections
        fetch(fetchUrl)
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrProducts = myJson;

          showBooks(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      function loadOrders(iPanel) {
        var fetchUrl = sheetURL + '/tabs/Orders';
        //if (true) fetchUrl += '/Highlight/*True*'; // {DebugPoint}
        //if (manUtils.getParam('book')) fetchUrl += '/ProductId/*' + manUtils.getParam('book') + '*'; // {DebugPoint}

        // GET Author's Collections
        fetch(fetchUrl)
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrOrders = myJson;

          showOrders(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      function loadSales(iPanel) {
        var fetchUrl = sheetURL + '/tabs/Sales/0:20';
        //if (true) fetchUrl += '/Highlight/*True*'; // {DebugPoint}
        //if (manUtils.getParam('book')) fetchUrl += '/ProductId/*' + manUtils.getParam('book') + '*'; // {DebugPoint}

        // GET Author's Collections
        fetch(fetchUrl)
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrSales = myJson;

          showSales(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      //custom max min header filter
      var minMaxFilterEditor = function(cell, onRendered, success, cancel, editorParams){

        var end;

        var container = document.createElement("span");

        //create and style inputs
        var start = document.createElement("input");
        start.setAttribute("type", "number");
        start.setAttribute("placeholder", "Min");
        start.setAttribute("min", 0);
        start.setAttribute("max", 100);
        start.style.padding = "4px";
        start.style.width = "50%";
        start.style.boxSizing = "border-box";

        start.value = cell.getValue();

        function buildValues(){
            success({
                start:start.value,
                end:end.value,
            });
        }

        function keypress(e){
            if(e.keyCode == 13){
                buildValues();
            }

            if(e.keyCode == 27){
                cancel();
            }
        }

        end = start.cloneNode();
        end.setAttribute("placeholder", "Max");

        start.addEventListener("change", buildValues);
        start.addEventListener("blur", buildValues);
        start.addEventListener("keydown", keypress);

        end.addEventListener("change", buildValues);
        end.addEventListener("blur", buildValues);
        end.addEventListener("keydown", keypress);


        container.appendChild(start);
        container.appendChild(end);

        return container;
     }

      //custom max min filter function
      function minMaxFilterFunction(headerValue, rowValue, rowData, filterParams){
          //headerValue - the value of the header filter element
          //rowValue - the value of the column in this row
          //rowData - the data for the row being filtered
          //filterParams - params object passed to the headerFilterFuncParams property

              if(rowValue){
                  if(headerValue.start != ""){
                      if(headerValue.end != ""){
                          return rowValue >= headerValue.start && rowValue <= headerValue.end;
                      }else{
                          return rowValue >= headerValue.start;
                      }
                  }else{
                      if(headerValue.end != ""){
                          return rowValue <= headerValue.end;
                      }
                  }
              }

          return true; //must return a boolean, true if it passes the filter.
      }
      var bookIcon = function(cell, formatterParams) {
          return "<i class='fa fa-book'></i>";
      };
      var cartIcon = function(cell, formatterParams) {
          return "<i class='fa fa-shopping-cart'></i>";
      };
      var emailIcon = function(cell, formatterParams){
          return "<i class='fa fa-envelope'></i>";
      };
      var profileIcon = function(cell, formatterParams) {
          return "<i class='fa fa-user'></i>";
      };
      var shareIcon = function(cell, formatterParams) {
          return "<i class='fa fa-share'></i>";
      };
      var thumbsUpIcon = function(cell, formatterParams) {
          return "<i class='fa fa-thumbs-up'></i>";
      };
      var trackingIcon = function(cell, formatterParams){
          return "<i class='fa fa-search'></i>";
      };
      var viewIcon = function(cell, formatterParams){
          return "<i class='fa fa-eye'></i>";
      };
      // Generate print icon
      var printIcon = function(cell, formatterParams){
          return (cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์') ? "<i class='fa fa-print'></i>" : '';
      };
      // Generate reject icon
      var rejectIcon = function(cell, formatterParams){
          return ((cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                  || (cell.getRow().getData().OrderStatus == 'ป้อนข้อมูลจัดส่ง' || cell.getRow().getData().OrderStatus == 'รอการชำระเงิน'))
                ? ''
                : (cell.getRow().getData().VerifyRejected  == 'True') ? "<i class='fa fa-times'></i>" : "<i class='fa fa-thumbs-down'></i>";
      };
      // Generate confirm icon
      var verifyIcon = function(cell, formatterParams){
          return ((cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                  || (cell.getRow().getData().OrderStatus == 'ป้อนข้อมูลจัดส่ง' || cell.getRow().getData().OrderStatus == 'รอการชำระเงิน'))
                  ? ''
                  : (cell.getRow().getData().PaymentVerified  == 'True') ? "<i class='fa fa-check'></i>" : "<i class='fa fa-thumbs-up'></i>";
      };
      function swapHighlight(productId, value) {
        fetch(sheetURL + '/tabs/Products/ProductId/*' + productId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              Highlight: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-book&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }
      function swapBestSeller(productId, value) {
        fetch(sheetURL + '/tabs/Products/ProductId/*' + productId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              BestSeller: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-book&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }
      function swapAvailable(productId, value) {
        fetch(sheetURL + '/tabs/Products/ProductId/*' + productId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              Available: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-book&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }
      function swapPrivateSale(productId, value) {
        fetch(sheetURL + '/tabs/Products/ProductId/*' + productId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              PrivateSale: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-book&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onInputTrackingId(orderId, value) {
        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              TrackingCode: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          //window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onSelectTransporter(orderId, value) {
        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              Transporter: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          //window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onVerifyPayment(orderId, datePayment) {
        // Update 'Orders'
        // -- Update 'Sales'
        // ---- completePurchase()
        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          { method: "PATCH", mode: "cors",
            headers: { "Content-Type": "application/json",},
            body: JSON.stringify({
              OrderStatus: 'ชำระเงินเสร็จสมบูรณ์',
              PaymentVerified: 'True',
              VerifyRejected: 'False',
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          // Update 'Sales'
          fetch(sheetURL + '/tabs/Sales/OrderId/*' + orderId + '*',
            {method: "PATCH", mode: "cors",
              headers: { "Content-Type": "application/json",},
              body: JSON.stringify({
                PaymentStatus: 'ชำระเงินเสร็จสมบูรณ์',
                PaymentDate: datePayment,
              }),
            }
          )
          .then((response) => { return response.json(); })
          .then((data) => {
            completePurchase(orderId, datePayment);
            window.location.href = "admin.html?id=main-order&key=" + key;
          })
          .catch((error) => { console.log(error); });
        })
        .catch((error) => { console.log(error); });
      }

      function onRejectPayment(orderId) {
        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              OrderStatus: 'ชำระเงินแล้วรอตรวจสอบ',
              PaymentVerified: 'False',
              VerifyRejected: 'True',
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function completePurchase(orderId, datePayment) {
        // ---- Update 'Products'
        // ------ Update 'Contacts' (Share)
        // -------- Update 'Payments'
        // ---------- Update 'Publisher'
        fetch(sheetURL + '/tabs/Sales/OrderId/*' + orderId + '*')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          for (var i in myJson) {

          }
        })
        .catch((error) => { console.log(error); });
      }

      function showDashboard(panel) {
        // Copyright Share Report
        document.getElementById('panel-header').innerHTML = 'เงินเข้า';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');

        var deck = document.createElement('div');
        deck.className = 'card-deck mb-3 text-center';
        panel.appendChild(deck);

        // Balance
        var data = {
          ElementID: 'bank-balance',
          Title: 'ยอดคงเหลือในบัญชี',
          Value: manUtils.formatNumber(0, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'success',
          Remark: '= (1) + (2)',
        };
        spawnCard(deck, data);

        // Main Income
        var data = {
          ElementID: 'income-main',
          Title: 'รายได้จากการขาย <sup>(1)</sup>',
          Value: manUtils.formatNumber(0, 0),
          Unit: 'บาท',
          TextColor: 'black',
          Color: 'light',
          Remark: 'รวมยอดโอนเข้าจากคำสั่งซื้อ (ราคาปก + ค่าจัดส่ง)',
        };
        spawnCard(deck, data);

        // Misc. Income
        var data = {
          ElementID: 'income-misc',
          Title: 'รายได้อื่น ๆ <sup>(2)</sup>',
          Value: manUtils.formatNumber(0, 0),
          Unit: 'บาท',
          TextColor: 'black',
          Color: 'light',
          Remark: 'รวมยอดโอนเข้าจากกรณีอื่น อาทิ ดอกเบี้ย',
        };
        spawnCard(deck, data);

        var pShare = document.createElement('p');
        pShare.innerHTML = '<h3>เงินออก</h3><p>' + manUtils.getGlobalVars('loremShort') + '</p>';
        panel.appendChild(pShare);

        var deckShare = document.createElement('div');
        deckShare.className = 'card-deck mb-3 text-center';
        panel.appendChild(deckShare);

        // Publisher Share
        var data = {
          ElementID: 'share-publisher',
          Title: 'ส่วนแบ่งสำนักพิมพ์',
          Value: manUtils.formatNumber(0, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'primary',
          Remark: '= (1) + (2) - (3) - (4) หรือ เท่ากับ<br/>(ต้นทุนผลิต + ค่าจัดส่ง + % ค่าดำเนินการ)<br>หัก (ส่วนแบ่งค่าลิขสิทธิ์ + ส่วนแบ่งแพลตฟอร์ม)',
        };
        spawnCard(deckShare, data);

        // Copyright Share
        var data = {
          ElementID: 'share-copyright',
          Title: 'ส่วนแบ่งค่าลิขสิทธิ์ <sup>(3)</sup>',
          Value: manUtils.formatNumber(0, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'secondary',
          Remark: 'ยอดส่วนแบ่งค่าลิขสิทธิ์รอโอน',
        };
        spawnCard(deckShare, data);

        // Platform Share
        var data = {
          ElementID: 'share-platform',
          Title: 'ส่วนแบ่งแพลตฟอร์ม <sup>(4)</sup>',
          Value: manUtils.formatNumber(0, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'dark',
          Remark: 'ยอดส่วนแบ่งแพลตฟอร์มรอโอน',
        };
        spawnCard(deckShare, data);

        // HR
        panel.appendChild(document.createElement('hr'));

        var hTable = document.createElement('h3');
        hTable.innerHTML = 'รายการบัญชี';
        panel.appendChild(hTable);

        var pTableGuide = document.createElement('p');
        pTableGuide.innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(pTableGuide);

        var table = document.createElement('div');
        table.id = 'tabulator-payments';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-payments", {
            data:arrPayments, //set initial table data
            columns:[
              {title:"วันที่", width:100, field:"PaymentDate", headerFilter:"input"},
              {title:"เวลา", hozAlign:"right", field:"PaymentTime", hozAlign:"center"},
              {title:"เลขที่คำสั่ง", width:100, field:"OrderId"},
              {title:"เข้า", hozAlign:"right", field:"Income"},
              {title:"ออก", hozAlign:"right", field:"Outcome"},
              {title:"รายการ", width:200, field:"Content", headerFilter:"input"},
              {title:"ผู้โอน/รับโอน", width:130, field:"ContactName", headerFilter:"input"},
              {title:"เลขที่บัญชี", width:120, field:"BankAccountId"},
              {title:"ช่องทาง", width:100, field:"BankName"},
            ],
        });

        var cmdDiv = document.createElement('p');
        var html = "";
        html += '<p><h3>เพิ่มรายการบัญชี</h3>';
        html += '<button type="button" class="btn btn-outline-secondary">รับดอกเบี้ย</button>';
        html += '&nbsp;&nbsp;<button type="button" class="btn btn-dark">จ่ายส่วนแบ่งแพลตฟอร์ม</button>';
        html += '</p>';
        cmdDiv.innerHTML = html;
        panel.appendChild(cmdDiv);

        // HR
        panel.appendChild(document.createElement('hr'));
      }

      function showContacts(panel) {
        document.getElementById('panel-header').innerHTML = 'นักเขียน (' + arrContacts.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var deck = document.createElement('div');
        deck.className = 'card-deck mb-3 text-center';
        panel.appendChild(deck);

        // Due Payment
        var data = {
          ElementID: 'payment-instantly',
          Title: 'รายการต้องโอน',
          Value: manUtils.formatNumber(0, 0),
          Unit: 'รายการ',
          TextColor: 'white',
          Color: 'danger',
          Remark: 'จำนวนผู้ถึงรอบชำระค่าลิขสิทธิ์ใน 3 วันนี้',
        };
        spawnCard(deck, data);

        // Application Approve
        var data = {
          ElementID: 'application-approval',
          Title: 'รออนุมัติใบสมัคร',
          Value: manUtils.formatNumber(29, 0),
          Unit: 'ราย',
          TextColor: 'white',
          Color: 'primary',
          Remark: 'จำนวนผู้รอการตรวจสอบข้อมูลใบสมัคร',
        };
        spawnCard(deck, data);

        // Number of Contacts
        var data = {
          ElementID: 'active-contacts',
          Title: 'จำนวนนักเขียน',
          Value: manUtils.formatNumber(10, 0),
          Unit: 'คน',
          TextColor: 'white',
          Color: 'success',
          Remark: 'นับเฉพาะผู้มียอดขายใน 1 ปีที่ผ่านมา',
        };
        spawnCard(deck, data);

        var table = document.createElement('div');
        table.id = 'tabulator-contacts';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-contacts", {
            data:arrContacts, //set initial table data
            columns:[
              {field:"Enable", hozAlign:"center", formatter:"tickCross"},
              {formatter:profileIcon, hozAlign:"center", cellClick:function(e, cell){
                //console.log(cell);
                window.open(manUtils.getGlobalVars('reportURL') + "?id=main-dashboard&key=" + cell.getRow().getData().ContactId);
              }},
              {title:"ชื่อ", field:"FirstName", headerFilter:"input", formatter:function(cell, formatterParams){
                 return manUtils.formatName(cell.getRow().getData().Title, cell.getRow().getData().FirstName, cell.getRow().getData().LastName);
              }},
              {formatter:cartIcon, hozAlign:"center", cellClick:function(e, cell){
                //console.log(cell);
                window.open(manUtils.getGlobalVars('shopURL') + "?id=" + cell.getRow().getData().ContactId);
              }},
              {title:"ขาย (เล่ม)", hozAlign:"right", formatter:function(cell, formatterParams){
                 return manUtils.formatNumber(cell.getRow().getData().SaleCount, 0);
              }},
              {title:"รับแล้ว (บ.)", hozAlign:"right", formatter:function(cell, formatterParams){
                 return manUtils.formatNumber(cell.getRow().getData().ShareReceived, 0);
              }},
              {title:"รอโอน (บ.)", hozAlign:"right", formatter:function(cell, formatterParams){
                 return manUtils.formatNumber(cell.getRow().getData().ShareAwait, 0);
              }},
              {title:"รอบจ่าย", hozAlign:"center", formatter:function(cell, formatterParams){
                return cell.getRow().getData().BillPeriod + ' เดือน';
              }},
              {title:"รอบหน้า", field:"NextPaid", width:100, headerFilter:"input"},
              {title:"โอน", formatter:thumbsUpIcon, hozAlign:"center", cellClick:function(e, cell){
                //console.log(cell);
                //window.open(manUtils.getGlobalVars('reportURL') + "?id=main-dashboard&key=" + cell.getRow().getData().ContactId);
              }},
              {title:"ส่ง", width:60, formatter:emailIcon, hozAlign:"center", cellClick:function(e, cell){
                //console.log(cell);
                //window.open(manUtils.getGlobalVars('reportURL') + "?id=main-dashboard&key=" + cell.getRow().getData().ContactId);
              }},
            ],
        });
      }

      function showBooks(panel) {
        document.getElementById('panel-header').innerHTML = 'หนังสือ (' + arrProducts.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var table = document.createElement('div');
        table.id = 'tabulator-books';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-books", {
            data:arrProducts, //set initial table data
            columns:[
              {title:"ออกใหม่", field:"Highlight", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                swapHighlight(cell.getRow().getData().ProductId, (cell.getRow().getData().Highlight == 'True') ? 'False' : 'True');
              }},
              {title:"ขายดี", field:"BestSeller", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                swapBestSeller(cell.getRow().getData().ProductId, (cell.getRow().getData().BestSeller == 'True') ? 'False' : 'True');
              }},
              {formatter:bookIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('shopURL') + '?id=' + cell.getRow().getData().ContactId + '&book=' + cell.getRow().getData().ProductId);
              }},
              {title:"ชื่อหนังสือ", width:280, field:"Title", headerFilter:"input"},
              {title:"ผู้เขียน", width:180, field:"Author", headerFilter:"input"},
              {title:"ขาย (เล่ม)", field:"Amount", hozAlign:"center"},
              {title:"ซื้อได้", field:"Available", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                swapAvailable(cell.getRow().getData().ProductId, (cell.getRow().getData().Available == 'True') ? 'False' : 'True');
              }},
              {title:"เฉพาะบุคคล", field:"PrivateSale", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                swapPrivateSale(cell.getRow().getData().ProductId, (cell.getRow().getData().PrivateSale == 'True') ? 'False' : 'True');
              }},
            ],
        });
      }

      function showOrders(panel) {
        document.getElementById('panel-header').innerHTML = 'คำสั่งซื้อ (' + arrOrders.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var deck = document.createElement('div');
        deck.className = 'card-deck mb-3 text-center';
        panel.appendChild(deck);

        var incompleted = 0;
        var approval = 0;
        var awaiting = 0;

        for (var i in arrOrders) {
          if (arrOrders[i].OrderStatus == 'ป้อนข้อมูลจัดส่ง'
              || arrOrders[i].OrderStatus == 'รอการชำระเงิน') {
            incompleted++;
          }
          else if (arrOrders[i].OrderStatus == 'ชำระเงินแล้วรอตรวจสอบ') {
            approval++;
          }
          else if (arrOrders[i].OrderStatus == 'ชำระเงินเสร็จสมบูรณ์'
                   && arrOrders[i].TrackingCode == "") {
            awaiting++;
          }
        }

        // Payment Await
        var data = {
          ElementID: 'incompleted-order',
          Title: 'คำสั่งซื้อที่ไม่สมบูรณ์',
          Value: manUtils.formatNumber(incompleted, 0),
          Unit: 'รายการ',
          TextColor: 'white',
          Color: 'dark',
          Remark: 'คำสั่งซื้อที่อยู่ระหว่าง ป้อนข้อมูลจัดส่ง/รอการชำระเงิน',
        };
        spawnCard(deck, data);

        // Payment Approval
        var data = {
          ElementID: 'payment-approval',
          Title: 'รอยืนยันเงินโอน',
          Value: manUtils.formatNumber(approval, 0),
          Unit: 'รายการ',
          TextColor: 'white',
          Color: 'danger',
          Remark: 'ชำระเงินแล้ว รอการตรวจสอบและยืนยันการโอน',
        };
        spawnCard(deck, data);

        // Payment Approval
        var data = {
          ElementID: 'tracking-await',
          Title: 'รอการจัดส่งพัสดุ',
          Value: manUtils.formatNumber(awaiting, 0),
          Unit: 'รายการ',
          TextColor: 'white',
          Color: 'primary',
          Remark: 'ชำระเงินเสร็จสมบูรณ์ แต่ยังไม่มีเลขติดตามพัสดุ',
        };
        spawnCard(deck, data);

        var table = document.createElement('div');
        table.id = 'tabulator-orders';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-orders", {
            data:arrOrders, //set initial table data
            columns:[
              {title:"วันที่สั่งซื้อ", width:100, field:"CreatedDate", headerFilter:"input"},
              {formatter:viewIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('checkoutURL') + "?id=" + cell.getRow().getData().OrderId);
              }},
              {title:"เลขที่คำสั่ง", width:100, field:"OrderId"},
              {title:"สถานะคำสั่ง", width:180, field:"OrderStatus", editor:"select", editorParams:{"ป้อนข้อมูลจัดส่ง":"ป้อนข้อมูลจัดส่ง", "รอการชำระเงิน":"รอการชำระเงิน", "ชำระเงินแล้วรอตรวจสอบ":"ชำระเงินแล้วรอตรวจสอบ", "ชำระเงินเสร็จสมบูรณ์":"ชำระเงินเสร็จสมบูรณ์"}, headerFilter:true, headerFilterParams:{"ป้อนข้อมูลจัดส่ง":"ป้อนข้อมูลจัดส่ง", "รอการชำระเงิน":"รอการชำระเงิน", "ชำระเงินแล้วรอตรวจสอบ":"ชำระเงินแล้วรอตรวจสอบ", "ชำระเงินเสร็จสมบูรณ์":"ชำระเงินเสร็จสมบูรณ์"}},
              {formatter:verifyIcon, hozAlign:"center", cellClick:function(e, cell){
                if ((cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                    || (cell.getRow().getData().OrderStatus == 'ป้อนข้อมูลจัดส่ง' || cell.getRow().getData().OrderStatus == 'รอการชำระเงิน')) {
                } else {
                  onVerifyPayment(cell.getRow().getData().OrderId, cell.getRow().getData().PaymentDate);
                }
              }},
              {formatter:rejectIcon, hozAlign:"center", cellClick:function(e, cell){
                if ((cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                    || (cell.getRow().getData().OrderStatus == 'ป้อนข้อมูลจัดส่ง' || cell.getRow().getData().OrderStatus == 'รอการชำระเงิน')) {
                } else {
                  onRejectPayment(cell.getRow().getData().OrderId);
                }
              }},
              {title:"บ.", width:50, hozAlign:"right", formatter:function(cell, formatterParams){
                 return manUtils.formatNumber(cell.getRow().getData().GrandTotal, 0);
              }},
              {title:"วันแจ้งโอน", width:100, hozAlign:"center", field:"PaymentDate", headerFilter:"input"},
              {title:"เวลา", hozAlign:"center", field:"PaymentTime"},
              {title:"", field:"PaymentVerified", hozAlign:"center", formatter:"tickCross"},
              {formatter:printIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open("https://i.imgur.com/5hGMMJz.jpg");
              }},
              {title:"เลขที่พัสดุ", width:100, field:"TrackingCode", editor:"input", cellEdited:function(cell){
                if (cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                  onInputTrackingId(cell.getRow().getData().OrderId, cell.getValue());
                else window.location.href = "admin.html?id=main-order&key=" + key;
              }},
              {title:"ขนส่ง", width:80, field:"Transporter", editor:"select", editorParams:{"Flash":"Flash", "J&T":"J&T", "Kerry":"Kerry", "ThaiPost":"ThaiPost"}, cellEdited:function(cell){
                if (cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                  onSelectTransporter(cell.getRow().getData().OrderId, cell.getValue());
                else window.location.href = "admin.html?id=main-order&key=" + key;
              }},
              {formatter:trackingIcon, hozAlign:"center", cellClick:function(e, cell){
                var url = "";
                switch (cell.getRow().getData().Transporter) {
                  case 'Flash': url = manUtils.getGlobalVars('trackingFlash'); break;
                  case 'J&T': url = manUtils.getGlobalVars('trackingJ&T'); break;
                  case 'Kerry': url = manUtils.getGlobalVars('trackingKerry'); break;
                  case 'ThaiPost': url = manUtils.getGlobalVars('trackingThaiPost'); break;
                  default: url = "#"
                }
                window.open(url);
              }},
            ],
        });
      }

      function showSales(panel) {
        document.getElementById('panel-header').innerHTML = 'รายการขาย (' + arrSales.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var table = document.createElement('div');
        table.id = 'tabulator-sales';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-sales", {
            data:arrSales, //set initial table data
            columns:[
              {title:"สถานะ", width:160, field:"PaymentStatus", editor:"select", editorParams:{"รอการชำระเงิน":"รอการชำระเงิน", "ชำระเงินเสร็จสมบูรณ์":"ชำระเงินเสร็จสมบูรณ์"}, headerFilter:true, headerFilterParams:{"รอการชำระเงิน":"รอการชำระเงิน", "ชำระเงินเสร็จสมบูรณ์":"ชำระเงินเสร็จสมบูรณ์"}},
              {formatter:viewIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('checkoutURL') + "?id=" + cell.getRow().getData().OrderId);
              }},
              {title:"วันแจ้งโอน", width:100, hozAlign:"center", field:"PaymentDate", headerFilter:"input"},
              {title:"เวลา", hozAlign:"center", field:"PaymentTime"},
              {title:"ชื่อหนังสือ", width:250, field:"Title", headerFilter:"input"},
              {title:"ผู้เขียน", width:180, field:"Author", headerFilter:"input"},
              {title:"ซื้อ", width:60, field:"Amount", hozAlign:"center"},
              {title:"บ.", width:60, field:"Price", hozAlign:"center"},
              {title:"รวม", width:70, field:"SubTotal", hozAlign:"right"},
            ],
        });
      }

      function showSidebarMenu(menuId) {
        document.getElementById('menu-website').href = manUtils.getGlobalVars('websiteURL');

        var menuItems = [
          {icon: 'fa-home', caption: 'รายงานสรุป', name: 'main-dashboard', href: 'admin.html?id=main-dashboard&key=' + key},
          {icon: 'fa-user', caption: 'นักเขียน', name: 'main-contact', href: 'admin.html?id=main-contact&key=' + key},
          {icon: 'fa-book', caption: 'หนังสือ', name: 'main-book', href: 'admin.html?id=main-book&key=' + key},
          {icon: 'fa-shopping-cart', caption: 'คำสั่งซื้อ', name: 'main-order', href: 'admin.html?id=main-order&key=' + key},
          {icon: 'fa-clipboard', caption: 'รายการขาย', name: 'main-sale', href: 'admin.html?id=main-sale&key=' + key},
        ];
        var html = "";

        for (var i in menuItems) {
          var item = menuItems[i];
          html += '<li class="nav-item">';
            if (item.name == menuId)
              html += '<a class="nav-link active" href="' + item.href + '">';
            else html += '<a class="nav-link" href="' + item.href + '">';
              html += '<i class="fa ' + item.icon + ' fa-lg"></i>&nbsp;&nbsp;';
              html += item.caption;
              html += (item.name == menuId) ? '<span class="sr-only">(current)</span>' : '';
            html += '</a>';
          html += '</li>';
        }
        document.getElementById('menu-sidebar').innerHTML = html;
      }

      function spawnCard(deck, data) {
        var html = '';

        html += '<div class="card mb-4 box-shadow">';
          html += '<div class="card-header text-' + data.TextColor + ' bg-' + data.Color + '">';
            html += '<h5 class="my-0 font-weight-normal">' + data.Title + '</h5>';
          html += '</div>';
          html += '<div class="card-body">';
            html += '<h1 class="card-title pricing-card-title"><span id="' + data.ElementID + '">' + data.Value + '</span> <small><small>' + data.Unit + '</small></small></h1>';
            html += '<p class="card-text"><small class="text-muted">' + data.Remark + '</small></p>';
          html += '</div>';
        html += '</div>';

        deck.innerHTML += html;
      }

      function spawnMediaObject(panel, data) {
        var media = document.createElement('div');
        media.className = "media";
        var img = document.createElement('img');
        img.className = "mr-3";
        img.src = data.imageURL;
        img.style = "max-width:" + data.maxWidth + 'px;';
        media.appendChild(img);
        var mediaBody = document.createElement('div');
        media.appendChild(mediaBody);
        var h = document.createElement('h5');
        h.className = "mt-0";
        h.innerHTML = data.Title;
        mediaBody.appendChild(h);
        var mediaText = document.createElement('div');
        mediaText.innerHTML = '<p>' + data.Description + '</p>';
        mediaBody.appendChild(mediaText);

        panel.appendChild(media);
      }

      window.addEventListener('load', (event) => {
        // GET GlobalVars
        // -- GET Author Info
        fetch(sheetURL + '/tabs/GlobalVars')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          globalVars = myJson;

          init();
        })
        .catch((error) => { console.log(error); });
      });
    </script>
  </body>
</html>
