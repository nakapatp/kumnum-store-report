<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/favicon.ico">

    <title>ร้านหนังสือ "คำนำ" - หน้าแอดมิน</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Tabulator CSS-->
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/overlay.css" rel="stylesheet">
    <link href="css/dashboard.css" rel="stylesheet">
    <link href="css/pricing.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
  </head>

  <body>
    <div class="overlay" id="overlay"></div>

    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="https://store.kumnum.com">ร้านหนังสือ "คำนำ"</a>
      <div class="topnav-right" id="menu-topbar">

      </div>
    </nav>

    <div class="container-fluid" id="container-main">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column" id="menu-sidebar">
              <!-- Dynamically load sidebar menu item -->
            </ul>
            <hr>
            <ul class="nav flex-column mb-2">
              <li class="nav-item">
                <a class="nav-link" href="#" id="menu-website" target="_blank">
                  <i class="fa fa-globe fa-lg"></i>&nbsp;&nbsp;เว็บไซต์
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
          <div id="panel-content">
            <h3 id="panel-header"></h3>
            <p id="panel-description"></p>
          </div>
        </main>
      </div>
    </div>
    <!-- 404 Page -->
    <div class="container" id="container-404">
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-slim.min.js"><\/script>')</script>
    <!-- <script src="js/popper.min.js"></script> -->
    <!-- <script src="js/holder.min.js"></script> -->
    <script src="js/bootstrap.min.js"></script>
    <!-- <script src="js/moment.js"></script> -->

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>

    <!-- Font Awesome Kit Code -->
    <script src="https://kit.fontawesome.com/354ed2e7c0.js" crossorigin="anonymous"></script>

    <!-- Tabulator JS -->
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

    <!-- manUtils JavaScript -->
    <script src="js/manutils.js"></script>

    <!-- Dashboard JavaScript -->
    <script type="text/javascript">
      const sheetURL = 'https://sheet.best/api/sheets/5acb1568-5ff2-4717-81dc-23a4093f6cbc'; // Production
      //const sheetURL = 'https://sheet.best/api/sheets/86299b5c-1850-4f51-b969-a44721bfe390'; // Dev
      var menuId = (manUtils.getParam('id') == null || manUtils.getParam('id') == "") ? 'main-dashboard' : manUtils.getParam('id');
      var key = manUtils.getParam('key');
      var globalVars = null;
      var arrPayments = null;
      var arrContacts = null;
      var arrProducts = null;
      var arrOrders = null;
      var arrSales = null;
      var arrNewContacts = null;

      function init() {

        if (key == manUtils.getGlobalVars('keySuperAdmin')
            || key == manUtils.getGlobalVars('keyPublisher')
            || key == manUtils.getGlobalVars('keyAdmin')
            || key == manUtils.getGlobalVars('keyViewer')) {

          showSidebarMenu(menuId);

          // Show Panel Content
          var iPanel = document.getElementById('panel-content');
          switch (menuId) {
            case 'main-dashboard': loadPayments(iPanel); break;
            case 'main-contact': loadContacts(iPanel); break;
            case 'main-book': loadProducts(iPanel); break;
            case 'main-spec': loadProducts(iPanel); break;
            case 'main-order': loadOrders(iPanel); break;
            case 'main-sale': loadSales(iPanel); break;
            default:
          }
        } else {
          showPage404();
        }
        document.getElementById('overlay').remove();
      }

      function disableScreen() {
        var div= document.createElement("div");
        div.className += "overlay";
        document.body.appendChild(div);
      }

      function showPage404() {
        document.getElementById('container-main').style.display = 'none';
        var desc = 'คุณต้องการ <span class="text-primary"><i class="fa fa-key"></i> กุญแจลับ</span> เพื่อเข้าถึงและจัดการเนื้อหาส่วนนี้ได้<br/>';
        //desc += 'โปรดตรวจสอบอีเมลดังกล่าว หรือหากยังไม่ได้รับอีเมลยืนยัน กรุณาติดต่อเจ้าหน้าที่ของ "คำนำ" ที่ดูแลคุณอยู่';
        document.getElementById('container-404').innerHTML = manUtils.getHTML404('ขออภัย!', 'เราไม่พบข้อมูลที่คุณกำลังมองหา', desc);
      }

      function loadPayments(iPanel) {
        // GET Author Info
        fetch(sheetURL + '/tabs/Payments')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrPayments = myJson;

          showDashboard(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      function loadContacts(iPanel) {
        // GET Author Info
        fetch(sheetURL + '/tabs/Contacts')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrContacts = myJson;

          // GET NewContact
          fetch(sheetURL + '/tabs/NewContact')
          .then((response) => {
              return response.json();
          })
          .then((myJson) => {
            arrNewContacts = myJson;

            showContacts(iPanel);
          })
          .catch((error) => { console.log(error); });
        })
        .catch((error) => { console.log(error); });
      }

      function loadProducts(iPanel) {
        // GET Author's Collections
        fetch(sheetURL + '/tabs/Products')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrProducts = myJson;

          if (menuId == 'main-spec')
            showBookSpec(iPanel);
          else showBooks(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      function loadOrders(iPanel) {
        // GET Author's Collections
        fetch(sheetURL + '/tabs/Orders')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrOrders = myJson;

          showOrders(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      function loadSales(iPanel) {
        // GET Author's Collections
        fetch(sheetURL + '/tabs/Sales/0:300')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrSales = myJson;

          showSales(iPanel);
        })
        .catch((error) => { console.log(error); });
      }

      var bookIcon = function(cell, formatterParams) {
          return "<i class='fa fa-book'></i>";
      };
      var cartIcon = function(cell, formatterParams) {
          return "<i class='fa fa-shopping-cart'></i>";
      };
      var pencilIcon = function(cell, formatterParams){
          return "<i class='fa fa-pencil'></i>";
      };
      var profileIcon = function(cell, formatterParams) {
          return "<i class='fa fa-user'></i>";
      };
      var shareIcon = function(cell, formatterParams) {
          return "<i class='fa fa-share'></i>";
      };
      var thumbsUpIcon = function(cell, formatterParams) {
          return "<i class='fa fa-thumbs-up'></i>";
      };
      var trackingIcon = function(cell, formatterParams){
          return "<i class='fa fa-search'></i>";
      };
      var viewIcon = function(cell, formatterParams){
          return "<i class='fa fa-eye'></i>";
      };
      // Generate print icon
      var printIcon = function(cell, formatterParams){
          var icon = (cell.getRow().getData().TrackingCode == '') ? '<span class="text-primary"><i class="fa fa-print"></i></span>' : '<i class="fa fa-print"></i>';
          return (cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์') ? icon : '';
      };
      // Generate clipboard-list icon
      var specIcon = function(cell, formatterParams){
          var icon = (cell.getRow().getData().TrackingCode == '') ? '<span class="text-primary"><i class="fa fa-clipboard-list"></i></span>' : '<i class="fa fa-clipboard-list"></i>';
          return (cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์') ? icon : '';
      };
      // Generate reject icon
      var rejectIcon = function(cell, formatterParams){
          return ((cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                  || (cell.getRow().getData().OrderStatus == 'ป้อนข้อมูลจัดส่ง' || cell.getRow().getData().OrderStatus == 'รอการชำระเงิน'))
                ? ''
                : (cell.getRow().getData().VerifyRejected  == 1) ? '<span class="text-danger"><i class="fa fa-times"></i></span>' : '<span class="text-danger"><i class="fa fa-thumbs-down"></i></span>';
      };
      // Generate confirm icon
      var verifyIcon = function(cell, formatterParams){
          return ((cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                  || (cell.getRow().getData().OrderStatus == 'ป้อนข้อมูลจัดส่ง' || cell.getRow().getData().OrderStatus == 'รอการชำระเงิน'))
                  ? ''
                  : (cell.getRow().getData().VerifyRejected  == 1) ? '' : '<span class="text-danger"><i class="fa fa-thumbs-up"></i></span>';
      };

      function onEditTab(obj, tabName, queryKey, keyName, value, refresh = false) {
        //disableScreen();

        var data = {};
        data[keyName] = value;

        fetch(sheetURL + '/tabs/' + tabName + '/' + queryKey + '/*' + obj[queryKey] + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          if (refresh)
            window.location.href = "admin.html?id=main-book&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onEditBook(obj, keyName, value) {
        disableScreen();

        var data = {};
        data[keyName] = value;
        fetch(sheetURL + '/tabs/Products/ProductId/*' + obj.ProductId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-book&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onEditContact(obj, keyName, value) {
        if (key == manUtils.getGlobalVars('keySuperAdmin')
            || key == manUtils.getGlobalVars('keyPublisher')) {

          //disableScreen();

          var data = {};
          data[keyName] = value;
          fetch(sheetURL + '/tabs/Contacts/ContactId/*' + obj.ContactId + '*',
            {
              method: "PATCH",
              mode: "cors",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            }
          )
          .then((response) => { return response.json(); })
          .then((data) => {
            //window.location.href = "admin.html?id=main-book&key=" + key;
          })
          .catch((error) => { console.log(error); });
        }
      }

      function swapContactNotified(contactId, value) {
        disableScreen();

        fetch(sheetURL + '/tabs/Contacts/ContactId/*' + contactId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              Notified: String(value),
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-contact&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function swapOrderNotified(orderId, value) {
        disableScreen();

        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              Notified: String(value),
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onInputPaymentBankAccountId(ID, value) {
        fetch(sheetURL + '/tabs/Payments/ID/*' + ID + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              BankAccountId: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          //window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onSelectPaymentBankName(ID, value) {
        fetch(sheetURL + '/tabs/Payments/ID/*' + ID + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              BankName: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          //window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onInputTrackingId(orderId, value) {
        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              TrackingCode: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          //window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onSelectTransporter(orderId, value) {
        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              Transporter: value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          //window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function onEditBookSpec(obj, keyName, value) {
        if (key == manUtils.getGlobalVars('keySuperAdmin')
            || key == manUtils.getGlobalVars('keyPublisher')
            || key == manUtils.getGlobalVars('keyAdmin')) {

          var price = obj.Price;
          var cost = obj.Cost;

          var data = {};
          if (keyName == 'Price' || keyName == 'Cost') {
            if (keyName == 'Price') {
              price = value;

              data["PublisherShare"] = Math.ceil(cost * manUtils.getGlobalVars('publisherShareRatio') / 100);
              data["PlatformShare"] = Math.ceil(cost * manUtils.getGlobalVars('platformShareRatio') / 100);;
              data["SharePerUnit"] = Math.ceil(price - cost - data["PublisherShare"] - data["PlatformShare"]);
              data["CopyrightRatio"] = ((price - cost - data["PublisherShare"] - data["PlatformShare"]) / price) * 100;

            } else if (keyName == 'Cost') {
              cost = value;

              data["PublisherShare"] = Math.ceil(cost * manUtils.getGlobalVars('publisherShareRatio') / 100);
              data["PlatformShare"] = Math.ceil(cost * manUtils.getGlobalVars('platformShareRatio') / 100);;
              data["SharePerUnit"] = Math.ceil(price - cost - data["PublisherShare"] - data["PlatformShare"]);
              data["CopyrightRatio"] = ((price - cost - data["PublisherShare"] - data["PlatformShare"]) / price) * 100;
            }
          }
          data[keyName] = value;

          fetch(sheetURL + '/tabs/Products/ProductId/*' + obj.ProductId + '*',
            {
              method: "PATCH",
              mode: "cors",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            }
          )
          .then((response) => { return response.json(); })
          .then((data) => {
            //console.log(keyName + ':' + value)
            //window.location.href = "admin.html?id=main-order&key=" + key;
          })
          .catch((error) => { console.log(error); });
        }
      }

      function onVerifyPayment(orderId, grandTotal, datePayment, timePayment, shippingCost) {
        disableScreen();

        // Update 'Orders'
        // -- Update 'Sales'
        // ---- completePurchase()
        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          { method: "PATCH", mode: "cors",
            headers: { "Content-Type": "application/json",},
            body: JSON.stringify({
              OrderStatus: 'ชำระเงินเสร็จสมบูรณ์',
              PaymentVerified: "1",
              VerifyRejected: "0",
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          // Update 'Sales'
          fetch(sheetURL + '/tabs/Sales/OrderId/*' + orderId + '*',
            {method: "PATCH", mode: "cors",
              headers: { "Content-Type": "application/json",},
              body: JSON.stringify({
                PaymentStatus: 'ชำระเงินเสร็จสมบูรณ์',
                PaymentDate: datePayment,
              }),
            }
          )
          .then((response) => { return response.json(); })
          .then((data) => {
            completePurchase(orderId, grandTotal, datePayment, timePayment, shippingCost);
          })
          .catch((error) => { console.log(error); });
        })
        .catch((error) => { console.log(error); });
      }

      function onRejectPayment(orderId) {
        disableScreen();

        fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              OrderStatus: 'ชำระเงินแล้วรอตรวจสอบ',
              PaymentVerified: "0",
              VerifyRejected: "1",
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          window.location.href = "admin.html?id=main-order&key=" + key;
        })
        .catch((error) => { console.log(error); });
      }

      function completePurchase(orderId, grandTotal, datePayment, timePayment, shippingCost) {
        // ---- Update 'Products'  (Amount, CopyrightShare)
        // ---- Update 'Contacts' (SaleCount, ShareAwait)
        // -------- Insert 'Payments' (PaymentDate, PaymentTime, OrderId, Income, Content)
        // ---------- Update 'Publisher'
        fetch(sheetURL + '/tabs/Sales/OrderId/*' + orderId + '*')
        .then((response) => { return response.json(); })
        .then((myJson) => {

          var owner = new Array();
          var publisher = 0;
          var copyright = 0;
          var platform = 0;
          var production = 0;

          for (var i in myJson) {

            var sale = myJson[i];
            addSaleToProduct(sale.ProductId, sale.Amount);
            publisher += Number(sale.PublisherShare);
            copyright += Number(sale.CopyrightShare);
            platform += Number(sale.PlatformShare);
            production += Number(sale.ProductionCost);

            if (!manUtils.arrayHasKeyValue(owner, 'ContactId', sale.ContactId)) {
              var data = {
                ContactId: sale.ContactId,
                SaleCount: sale.Amount,
                ShareAwait: sale.CopyrightShare,
              };
              owner.push(data);

            } else {
              for (var j in owner) {
                if (owner[j].ContactId == sale.ContactId) {
                  var count = Number(owner[j].SaleCount);
                  var share = Number(owner[j].ShareAwait);
                  count += Number(sale.Amount);
                  share += Number(sale.CopyrightShare);
                  owner[j].SaleCount = count;
                  owner[j].ShareAwait = share;
                  break;
                }
              }
            }
          }

          for (var i in owner) {
            addSaleToContact(owner[i].ContactId, owner[i].SaleCount, owner[i].ShareAwait);
          }

          // Insert 'Payments'
          const trans = {
            ID: String(manUtils.generateID()),
            PaymentDate: datePayment,
            PaymentTime: timePayment,
            OrderId: orderId,
            Income: grandTotal,
            Content: 'คำสั่งซื้อ #' + orderId,
            PublisherShare: publisher,
            CopyrightShare: copyright,
            PlatformShare: platform,
            ProductionCost: production,
            ShippingCost: (shippingCost == 0) ? "0" : shippingCost,
          };

          fetch(sheetURL + '/tabs/Payments', {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(trans),
          })
          .then((response) => { return response.json(); })
          .then((myJson) => {
            //console.log('completePurchase()');
            window.location.href = "admin.html?id=main-order&key=" + key;
          })
          .catch((error) => { console.log(error); });
        })
        .catch((error) => { console.log(error); });
      }

      function addSaleToProduct(productId, num) {
        // ---- Update 'Products'  (Amount, CopyrightShare)
        fetch(sheetURL + '/tabs/Products/ProductId/*' + productId + '*')
        .then((response) => { return response.json(); })
        .then((myJson) => {

          fetch(sheetURL + '/tabs/Products/ProductId/*' + productId + '*', {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              Amount: (Number(myJson[0].Amount) + Number(num)),
              CopyrightShare: (Number(myJson[0].CopyrightShare) + (num * myJson[0].SharePerUnit)),
            }),
          })
          .then((response) => { return response.json(); })
          .then((myJson) => {
            //console.log('addSaleToProduct()');
            //window.location.href = "admin.html?id=main-order&key=" + key;
          })
          .catch((error) => { console.log(error); });
        })
        .catch((error) => { console.log(error); });
      }

      function addSaleToContact(contactId, num, share) {
        // ---- Update 'Contacts' (SaleCount, ShareAwait)
        fetch(sheetURL + '/tabs/Contacts/ContactId/*' + contactId + '*')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          var count = Number(myJson[0].SaleCount) + Number(num);
          var val = Number(myJson[0].ShareAwait) + Number(share);
          fetch(sheetURL + '/tabs/Contacts/ContactId/*' + contactId + '*', {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              SaleCount: count,
              ShareAwait: val,
            }),
          })
          .then((response) => { return response.json(); })
          .then((myJson) => {
            //console.log('addSaleToProduct()');
            //window.location.href = "admin.html?id=main-order&key=" + key;
          })
          .catch((error) => { console.log(error); });
        })
        .catch((error) => { console.log(error); });
      }

      function onClickIncome(obj) {
        disableScreen();

        var elementId = obj.getAttribute('data-name');
        var content = obj.getAttribute('data-content');
        var amount = document.getElementById(elementId).value;

        if (amount > 0) {
          var d = new Date();
          var currentDate = d.toISOString().slice(0, 10);
          var currentTime = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(11,16);

          fetch(sheetURL + '/tabs/Payments', {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ID: String(manUtils.generateID()),
              PaymentDate: currentDate,
              PaymentTime: currentTime,
              Income: amount,
              Content: content,
            }),
          })
          .then((response) => { return response.json(); })
          .then((myJson) => {

            window.location.href = "admin.html?id=main-dashboard&key=" + key;
          })
          .catch((error) => { console.log(error); });
        }
      }

      function onClickOutcome(obj) {
        disableScreen();

        var elementId = obj.getAttribute('data-name');
        var content = obj.getAttribute('data-content');
        var amount = document.getElementById(elementId).value;

        if (amount > 0) {
          var d = new Date();
          var currentDate = d.toISOString().slice(0, 10);
          var currentTime = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(11,16);

          fetch(sheetURL + '/tabs/Payments', {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ID: String(manUtils.generateID()),
              PaymentDate: currentDate,
              PaymentTime: currentTime,
              Outcome: amount,
              Content: content,
            }),
          })
          .then((response) => { return response.json(); })
          .then((myJson) => {

            window.location.href = "admin.html?id=main-dashboard&key=" + key;
          })
          .catch((error) => { console.log(error); });
        }
      }

      function onClickOutcomeCopyright(contact) {
        if (contact.ShareAwait > 0) {
          disableScreen();

          var d = new Date();
          var currentDate = d.toISOString().slice(0, 10);
          var currentTime = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(11,16);
          var billDate = new Date(contact.NextPaid);
          var nextDate = new Date(billDate.setDate(billDate.getDate() + (contact.BillPeriod * 30)));

          fetch(sheetURL + '/tabs/Payments', {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ID: String(manUtils.generateID()),
              PaymentDate: currentDate,
              PaymentTime: currentTime,
              Outcome: contact.ShareAwait,
              Content: 'ค่าลิขสิทธิ์ ID.' + contact.ContactId,
              ContactId: contact.ContactId,
              ContactName: manUtils.formatName(contact.Title, contact.FirstName, contact.LastName),
              BankAccountId: contact.BankAccountId,
              BankName: contact.BankName,
            }),
          })
          .then((response) => { return response.json(); })
          .then((myJson) => {
            var received = Number(contact.ShareReceived) + Number(contact.ShareAwait);

            fetch(sheetURL + '/tabs/Contacts/ContactId/*' + contact.ContactId + '*', {
              method: "PATCH",
              mode: "cors",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                 ShareReceived: received,
                 ShareLatest: contact.ShareAwait,
                 ShareAwait: "0",
                 NextPaid: nextDate.toISOString().slice(0, 10),
              }),
            })
            .then((response) => { return response.json(); })
            .then((myJson) => {
              window.location.href = "admin.html?id=main-contact&key=" + key;
            })
            .catch((error) => { console.log(error); });
          })
          .catch((error) => { console.log(error); });
        }
      }

      function showDashboard(panel) {
        // Copyright Share Report
        document.getElementById('panel-header').innerHTML = 'รายรับ';
        document.getElementById('panel-description').innerHTML = 'รายรับของแพลตฟอร์มมี 2 ทางได้แก่ รายได้จากยอดขาย <sup>1</sup> และ รายได้อื่น ๆ <sup>2</sup>';

        var deck = document.createElement('div');
        deck.className = 'card-deck mb-3 text-center';
        panel.appendChild(deck);

        var bankBalance = 0;
        var incomeMain = 0;
        var incomeMisc = 0;

        var outcomePublisher = 0;
        var outcomeCopyright = 0;
        var outcomePlatform = 0;
        var outcomeProduction = 0;
        var outcomeShipping = 0;
        var outcomeMisc = 0;

        var sharePublisher = 0;
        var shareCopyright = 0;
        var sharePlatform = 0;
        var costProduction = 0;
        var costShipping = 0;
        //var costMisc = 0;

        var collectiveIncomeMain = 0;
        var collectiveIncomeMisc = 0;

        var collectiveSharePublisher = 0;
        var collectiveShareCopyright = 0;
        var collectiveSharePlatform = 0;
        var collectiveProductionCost = 0;
        var collectiveShippingCost = 0;
        var collectiveMiscCost = 0;

        var sumIncome = 0;
        var sumOutcome = 0;

        for (var i in arrPayments) {
          if (arrPayments[i].Income > 0) {
            if (arrPayments[i].Content.includes('คำสั่งซื้อ'))
              collectiveIncomeMain += Number(arrPayments[i].Income);
            else collectiveIncomeMisc += Number(arrPayments[i].Income);

            collectiveSharePublisher += Number(arrPayments[i].PublisherShare);
            collectiveShareCopyright += Number(arrPayments[i].CopyrightShare);
            collectiveSharePlatform += Number(arrPayments[i].PlatformShare);
            collectiveProductionCost += Number(arrPayments[i].ProductionCost);
            collectiveShippingCost += Number(arrPayments[i].ShippingCost);
            //collectiveMiscCost += Number(arrPayments[i].MiscCost);

            sumIncome += Number(arrPayments[i].Income);
          }
          if (arrPayments[i].Outcome > 0) {
            if (arrPayments[i].Content.includes('สำนักพิมพ์'))
              outcomePublisher += Number(arrPayments[i].Outcome);
            else if (arrPayments[i].Content.includes('ค่าลิขสิทธิ์'))
              outcomeCopyright += Number(arrPayments[i].Outcome);
            else if (arrPayments[i].Content.includes('แพลตฟอร์ม'))
              outcomePlatform += Number(arrPayments[i].Outcome);
            else if (arrPayments[i].Content.includes('ค่าผลิต'))
              outcomeProduction += Number(arrPayments[i].Outcome);
            else if (arrPayments[i].Content.includes('ค่าจัดส่ง'))
              outcomeShipping += Number(arrPayments[i].Outcome);
            else if (arrPayments[i].Content.includes('ค่าใช้จ่าย'))
              outcomeMisc += Number(arrPayments[i].Outcome);

            sumOutcome += Number(arrPayments[i].Outcome);
          }
        }
        bankBalance = sumIncome - sumOutcome;
        sharePublisher = collectiveSharePublisher - outcomePublisher;
        shareCopyright = collectiveShareCopyright - outcomeCopyright;
        sharePlatform = collectiveSharePlatform - outcomePlatform;
        costProduction = collectiveProductionCost - outcomeProduction;
        costShipping = collectiveShippingCost - outcomeShipping;
        //costMisc = collectiveMiscCost - outcomeMisc;
        collectiveMiscCost = outcomeMisc;


        // Main Income
        var data = {
          ElementID: 'income-main',
          Title: 'รายได้จากยอดขายสะสม <sup>1</sup>',
          Value: manUtils.formatNumber(collectiveIncomeMain, 0),
          Unit: 'บาท',
          TextColor: 'black',
          Color: 'light',
          Remark: 'รวมยอดโอนของคำสั่งซื้อ (รวมราคาปก + ค่าจัดส่ง)',
        };
        spawnCard(deck, data);

        // Misc. Income
        var data = {
          ElementID: 'income-misc',
          Title: 'รายได้อื่น ๆ สะสม <sup>2</sup>',
          Value: manUtils.formatNumber(collectiveIncomeMisc, 2),
          Unit: 'บาท',
          TextColor: 'black',
          Color: 'light',
          Remark: '= ดอกเบี้ย + เงินฝาก',
        };
        spawnCard(deck, data);

        // Balance
        var data = {
          ElementID: 'bank-balance',
          Title: 'ยอดคงเหลือในบัญชี',
          Value: manUtils.formatNumber(bankBalance, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'success',
          Remark: '= ส่วนแบ่งรอโอน + ส่วนต่างคงเหลือ',
        };
        spawnCard(deck, data);

        var pShare = document.createElement('p');
        pShare.innerHTML = '<h3>รายจ่าย</h3><p>รายจ่ายของแพลตฟอร์มมี 6 ทาง ได้แก่ ส่วนแบ่งสำนักพิมพ์, ค่าลิขสิทธิ์, ส่วนแบ่งแฟลตฟอร์ม, ค่าผลิต, ค่าจัดส่ง และค่าใช้จ่ายอื่น ๆ</p>';
        panel.appendChild(pShare);

        var deckShare = document.createElement('div');
        deckShare.className = 'card-deck mb-3 text-center';
        panel.appendChild(deckShare);

        // Publisher Share
        var data = {
          ElementID: 'share-publisher',
          Title: 'ส่วนแบ่งสำนักพิมพ์รอโอน <sup>3</sup>',
          Value: manUtils.formatNumber(sharePublisher, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'primary',
          Remark: 'ส่วนแบ่งสำนักพิมพ์สะสม ' + manUtils.formatNumber(collectiveSharePublisher, 0) + ' บ.',
        };
        spawnCard(deckShare, data);

        // Platform Share
        var data = {
          ElementID: 'share-platform',
          Title: 'ส่วนแบ่งแพลตฟอร์มรอโอน <sup>5</sup>',
          Value: manUtils.formatNumber(sharePlatform, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'primary',
          Remark: 'ส่วนแบ่งแพลตฟอร์มสะสม ' + manUtils.formatNumber(collectiveSharePlatform, 0) + ' บ.',
        };
        spawnCard(deckShare, data);

        // Copyright Share
        var data = {
          ElementID: 'share-copyright',
          Title: 'ค่าลิขสิทธิ์รอโอน <sup>4</sup>',
          Value: manUtils.formatNumber(shareCopyright, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'primary',
          Remark: 'ค่าลิขสิทธิ์สะสม ' + manUtils.formatNumber(collectiveShareCopyright, 0) + ' บ.',
        };
        spawnCard(deckShare, data);

        // HR
        panel.appendChild(document.createElement('hr'));

        var deckExpense = document.createElement('div');
        deckExpense.className = 'card-deck mb-3 text-center';
        panel.appendChild(deckExpense);

        // Expense Production
        var data = {
          ElementID: 'expense-production',
          Title: 'ค่าผลิตรอโอน <sup>6</sup>',
          Value: manUtils.formatNumber(costProduction, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'info',
          Remark: 'ค่าผลิตสะสม ' + manUtils.formatNumber(collectiveProductionCost, 0) + ' บ.',
        };
        spawnCard(deckExpense, data);

        // Expense Shipping
        var data = {
          ElementID: 'expense-shipping',
          Title: 'ค่าจัดส่งรอโอน <sup>7</sup>',
          Value: manUtils.formatNumber(costShipping, 0),
          Unit: 'บาท',
          TextColor: 'white',
          Color: 'info',
          Remark: 'ค่าจัดส่งสะสม ' + manUtils.formatNumber(collectiveShippingCost, 0) + ' บ.',
        };
        spawnCard(deckExpense, data);

        // Expense Other
        var data = {
          ElementID: 'expense-others',
          Title: 'ค่าใช้จ่ายสะสม  <sup>8</sup>',
          Value: manUtils.formatNumber(collectiveMiscCost, 0),
          Unit: 'บาท',
          TextColor: 'black',
          Color: 'light',
          Remark: 'ค่าใช้จ่ายที่ต้องอาศัย ดอกเบี้ยและเงินฝาก<sup>2</sup> รองรับ',
        };
        spawnCard(deckExpense, data);

        // HR
        panel.appendChild(document.createElement('hr'));

        var hTable = document.createElement('h3');
        hTable.innerHTML = 'รายการบัญชี';
        panel.appendChild(hTable);

        var pTableGuide = document.createElement('p');
        pTableGuide.innerHTML = 'บันทึกรายรับ-รายจ่ายของแพลตฟอร์ม เพื่อกระทบยอดกับยอดบัญชีเงินฝาก';
        panel.appendChild(pTableGuide);

        var table = document.createElement('div');
        table.id = 'tabulator-payments';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-payments", {
            maxHeight:450,
            data:arrPayments, //set initial table data
            columns:[
              {title:"วันที่", width:100, field:"PaymentDate", headerFilter:"input"},
              {title:"เวลา", hozAlign:"right", field:"PaymentTime", hozAlign:"center"},
              {title:"เลขที่คำสั่ง", width:120, field:"OrderId"},
              {title:"รับ", hozAlign:"right", field:"Income", bottomCalc:"sum"},
              {title:"จ่าย", hozAlign:"right", field:"Outcome", bottomCalc:"sum"},
              {title:"รายการ", width:200, field:"Content", headerFilter:"input"},
              {title:"ผู้โอน/รับโอน", width:150, field:"ContactName", headerFilter:"input"},
              {title:"เลขที่บัญชี", width:130, field:"BankAccountId", editor:"input", cellEdited:function(cell){
                onInputPaymentBankAccountId(cell.getRow().getData().ID, cell.getValue());
              }},
              {title:"ช่องทาง", width:100, field:"BankName", editor:"select", editorParams:{"ธ.กรุงเทพ":"ธ.กรุงเทพ", "ธ.กสิกรไทย":"ธ.กสิกรไทย", "ธ.ไทยพาณิชย์":"ธ.ไทยพาณิชย์", "ธ.กรุงไทย":"ธ.กรุงไทย", "ธ.ทหารไทย":"ธ.ทหารไทย", "ธ.ออมสิน":"ธ.ออมสิน", "ธ.กรุงศรีอยุธยา":"ธ.กรุงศรีอยุธยา", "พร้อมเพย์":"พร้อมเพย์"}, cellEdited:function(cell){
                onSelectPaymentBankName(cell.getRow().getData().ID, cell.getValue());
              }},
            ],
        });

        // HR
        panel.appendChild(document.createElement('hr'));

        if (key == manUtils.getGlobalVars('keySuperAdmin')
            || key == manUtils.getGlobalVars('keyPublisher')) {

          var hCommand = document.createElement('h3');
          hCommand.innerHTML = 'เพิ่มรายการบัญชี <span class="badge badge-danger">ฝ่ายการเงิน</span>';
          panel.appendChild(hCommand);

          var cmdDiv = document.createElement('div');
          cmdDiv.className = "row";
          cmdDiv.style = "margin-top:20px";
          var html = "";

          html += '<div class="col-md-4">';
            html += '<div class="input-group">';
              html += '<input type="input" class="form-control" id="income-interest" placeholder="ระบุจำนวน">';
              html += '<div class="input-group-append"><button class="btn btn-outline-secondary" onclick="onClickIncome(this)" data-name="income-interest" data-content="ดอกเบี้ย">(รับ) ดอกเบี้ย</button></div>';
            html += '</div>';
          html += '</div>';

          html += '<div class="col-md-4">';
            html += '<div class="input-group">';
              html += '<input type="input" class="form-control" id="outcome-publisher" placeholder="ระบุจำนวน">';
              html += '<div class="input-group-append"><button class="btn btn-primary" onclick="onClickOutcome(this)" data-name="outcome-publisher" data-content="ส่วนแบ่งสำนักพิมพ์">(จ่าย) ส่วนแบ่งสำนักพิมพ์</button></div>';
            html += '</div>';
          html += '</div>';

          html += '<div class="col-md-4">';
            html += '<div class="input-group">';
              html += '<input type="input" class="form-control" id="outcome-platform" placeholder="ระบุจำนวน">';
              html += '<div class="input-group-append"><button class="btn btn-dark" onclick="onClickOutcome(this)" data-name="outcome-platform" data-content="ส่วนแบ่งแพลตฟอร์ม">(จ่าย) ส่วนแบ่งแพลตฟอร์ม</button></div>';
              html += '<div style="margin-left:5px; margin-top:5px;">' + manUtils.getGlobalVars('platformBankAccountId') + ' ' + manUtils.getGlobalVars('platformBankAccountName') + '</div>';
            html += '</div>';
          html += '</div>';

          cmdDiv.innerHTML = html;
          panel.appendChild(cmdDiv);

          var cmdDiv2 = document.createElement('div');
          cmdDiv2.className = "row";
          cmdDiv2.style = "margin-top:10px";
          var html = "";

          html += '<div class="col-md-4">';
            html += '<div class="input-group">';
              html += '<input type="input" class="form-control" id="outcome-production" placeholder="ระบุจำนวน">';
              html += '<div class="input-group-append"><button class="btn btn-primary" onclick="onClickOutcome(this)" data-name="outcome-production" data-content="ค่าผลิต">(จ่าย) ค่าผลิต</button></div>';
            html += '</div>';
          html += '</div>';

          html += '<div class="col-md-4">';
            html += '<div class="input-group">';
              html += '<input type="input" class="form-control" id="outcome-shipping" placeholder="ระบุจำนวน">';
              html += '<div class="input-group-append"><button class="btn btn-info" onclick="onClickOutcome(this)" data-name="outcome-shipping" data-content="ค่าจัดส่ง">(จ่าย) ค่าจัดส่ง</button></div>';
            html += '</div>';
          html += '</div>';

          html += '<div class="col-md-4">';
            html += '<div class="input-group">';
              html += '<input type="input" class="form-control" id="outcome-misc" placeholder="ระบุจำนวน">';
              html += '<div class="input-group-append"><button class="btn btn-outline-secondary" onclick="onClickOutcome(this)" data-name="outcome-misc" data-content="ค่าใช้จ่าย">ค่าใช้จ่าย</button></div>';
            html += '</div>';
          html += '</div>';

          cmdDiv2.innerHTML = html;
          panel.appendChild(cmdDiv2);

          // HR
          panel.appendChild(document.createElement('hr'));
        }
      }

      function showContacts(panel) {
        document.getElementById('panel-header').innerHTML = 'นักเขียน (' + arrContacts.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var deck = document.createElement('div');
        deck.className = 'card-deck mb-3 text-center';
        panel.appendChild(deck);

        var numOfAwait = 0;
        var numOfNewContact = 0;

        if (arrNewContacts.length > 0) {
          for (var i in arrNewContacts)
            numOfNewContact++;
        }
        for (var i in arrContacts) {
          var d = new Date();
          var next = new Date(arrContacts[i].NextPaid);
          var diff = next.getDate() - d.getDate();
          if (diff <= 3 && arrContacts[i].ShareAwait > 0) numOfAwait++;
        }

        // Due Payment
        var data = {
          ElementID: 'payment-instantly',
          Title: 'รายการต้องโอน',
          Value: manUtils.formatNumber(numOfAwait, 0),
          Unit: 'รายการ',
          TextColor: 'white',
          Color: 'danger',
          Remark: 'จำนวนผู้ถึงรอบชำระค่าลิขสิทธิ์ใน 3 วันนี้',
        };
        spawnCard(deck, data);

        // Application Approve
        var data = {
          ElementID: 'application-approval',
          Title: 'รอจัดการใบสมัคร',
          Value: manUtils.formatNumber(numOfNewContact, 0),
          Unit: 'ราย',
          TextColor: 'white',
          Color: 'primary',
          Remark: 'จำนวนผู้รอการตรวจสอบข้อมูลใบสมัคร',
        };
        spawnCard(deck, data);

        // Number of Contacts
        var data = {
          ElementID: 'active-contacts',
          Title: 'จำนวนนักเขียน',
          Value: manUtils.formatNumber(manUtils.getGlobalVars('numOfContacts'), 0),
          Unit: 'คน',
          TextColor: 'white',
          Color: 'success',
          Remark: 'นับเฉพาะผู้มียอดขายใน 1 ปีที่ผ่านมา',
        };
        spawnCard(deck, data);

        var table = document.createElement('div');
        table.id = 'tabulator-contacts';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-contacts", {
            maxHeight:450,
            data:arrContacts, //set initial table data
            columns:[
              //{field:"Enable", hozAlign:"center", formatter:"tickCross"},
              {title:"แจ้ง", field:"Notified", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  swapContactNotified(cell.getRow().getData().ContactId, (cell.getRow().getData().Notified == 1) ? 0 : 1);
                }
              }},
              {formatter:profileIcon, hozAlign:"center", cellClick:function(e, cell){
                //console.log(cell);
                window.open(manUtils.getGlobalVars('reportURL') + "?id=main-dashboard&key=" + cell.getRow().getData().SecretKey);
              }},
              {title:"ชื่อ", width:180, field:"FirstName", formatter:function(cell, formatterParams){
                 return manUtils.formatName(cell.getRow().getData().Title, cell.getRow().getData().FirstName, cell.getRow().getData().LastName);
              }},
              {formatter:cartIcon, hozAlign:"center", cellClick:function(e, cell){
                //console.log(cell);
                window.open(manUtils.getGlobalVars('shopURL') + "?id=" + cell.getRow().getData().ContactId);
              }},
              {title:"(เล่ม)", width:70, hozAlign:"center", formatter:function(cell, formatterParams){
                 return manUtils.formatNumber(cell.getRow().getData().SaleCount, 0);
              }},
              {title:"รับแล้ว", hozAlign:"right", formatter:function(cell, formatterParams){
                 return manUtils.formatNumber(cell.getRow().getData().ShareReceived, 0);
              }},
              {title:"รอโอน", hozAlign:"right", formatter:function(cell, formatterParams){
                 return manUtils.formatNumber(cell.getRow().getData().ShareAwait, 0);
              }},
              {title:"รอบจ่าย", hozAlign:"center", formatter:function(cell, formatterParams){
                return cell.getRow().getData().BillPeriod + ' เดือน';
              }},
              {title:"รอบหน้า", field:"NextPaid", width:100, formatter:function(cell, formatterParams){
                var d = new Date();
                var next = new Date(cell.getRow().getData().NextPaid);
                var diff = next.getDate() - d.getDate();
                var text = manUtils.formatDateThai(cell.getRow().getData().NextPaid, true);
                return (diff <= 3 && cell.getRow().getData().ShareAwait > 0) ? '<span class="text-danger">' + text + '</span>' : text;
              }},
              {title:"โอน", formatter:thumbsUpIcon, hozAlign:"center", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  if (cell.getRow().getData().ShareAwait > 0)
                    onClickOutcomeCopyright(cell.getRow().getData());
                }
              }},
              {title:"หมายเลขบัญชี", field:"BankAccountId", editor:"input", cellEdited:function(cell){
                onEditContact(cell.getRow().getData(), 'BankAccountId', cell.getValue());
              }},
              {title:"ธนาคาร", field:"BankName", editor:"select", editorParams:{"ธ.กรุงเทพ":"ธ.กรุงเทพ", "ธ.กสิกรไทย":"ธ.กสิกรไทย", "ธ.ไทยพาณิชย์":"ธ.ไทยพาณิชย์", "ธ.กรุงไทย":"ธ.กรุงไทย", "ธ.ทหารไทย":"ธ.ทหารไทย", "ธ.ออมสิน":"ธ.ออมสิน", "ธ.กรุงศรีอยุธยา":"ธ.กรุงศรีอยุธยา", "พร้อมเพย์":"พร้อมเพย์"}, cellEdited:function(cell) {
                onEditContact(cell.getRow().getData(), 'BankName', cell.getValue());
              }},
            ],
        });

        // HR
        panel.appendChild(document.createElement('hr'));

        // Table of Sales Summary
        var hTableNewContact = document.createElement('h3');
        hTableNewContact.innerHTML = 'ใบสมัครรอจัดการ (' + numOfNewContact + ')';
        panel.appendChild(hTableNewContact);

        var pTableNewContact = document.createElement('p');
        pTableNewContact.innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(pTableNewContact);

        var tableNewContact = document.createElement('div');
        tableNewContact.id = 'tabulator-new-contact';
        panel.appendChild(tableNewContact);

        var table = new Tabulator("#tabulator-new-contact", {
            maxHeight:450,
            data:arrNewContacts, //set initial table data
            columns:[
              {title:"นำ", field:"Title", editor:"select", editorParams:{"":"", "ผศ.":"ผศ.", "ผศ.ดร.":"ผศ.ดร.", "ดร.":"ดร."}, cellEdited:function(cell) {
                //onEditBookSpec(cell.getRow().getData(), 'คำนำหน้า', cell.getValue());
                onEditTab(cell.getRow().getData(), 'NewContact', 'Phone', 'Title', cell.getValue());
              }},
              {title:"ชื่อ", field:"FirstName"},
              {title:"นามสกุล", field:"LastName"},
              {title:"โทรศัพท์", field:"Phone"},
              {title:"อีเมล", field:"Email"},
              {title:"บัญชีไลน์", field:"LineId"},
              {title:"สังกัด", field:"Biography"},
              {title:"เลขที่บัญชี", field:"BankAccountId", editor:"input", cellEdited:function(cell) {
                onEditTab(cell.getRow().getData(), 'NewContact', 'Phone', 'BankAccountId', cell.getValue());
              }},
              {title:"ชื่อธนาคาร", field:"BankName", editor:"select", editorParams:{"ธ.กรุงเทพ":"ธ.กรุงเทพ", "ธ.กสิกรไทย":"ธ.กสิกรไทย", "ธ.ไทยพาณิชย์":"ธ.ไทยพาณิชย์", "ธ.กรุงไทย":"ธ.กรุงไทย", "ธ.ทหารไทย":"ธ.ทหารไทย", "ธ.ออมสิน":"ธ.ออมสิน", "ธ.กรุงศรีอยุธยา":"ธ.กรุงศรีอยุธยา", "พร้อมเพย์":"พร้อมเพย์"}, cellEdited:function(cell) {
                onEditTab(cell.getRow().getData(), 'NewContact', 'Phone', 'BankName', cell.getValue());
              }},
              {title:"รอบชำระ", field:"BillPeriod", editor:"select", editorParams:{"1":"1", "2":"2", "3":"3", "4":"4", "6":"6", "12":"12"}, cellEdited:function(cell) {
                onEditTab(cell.getRow().getData(), 'NewContact', 'Phone', 'BillPeriod', cell.getValue());
              }},
              {title:"ภาพโปรไฟล์", field:"ImageProfile", editor:"input", cellEdited:function(cell) {
                onEditTab(cell.getRow().getData(), 'NewContact', 'Phone', 'ImageProfile', cell.getValue());
              }},
              {title:"P", field:"Publisher", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                onEditTab(cell.getRow().getData(), 'NewContact', 'Phone', 'Publisher', 1);
              }},
              {title:"D", field:"Developer", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                onEditTab(cell.getRow().getData(), 'NewContact', 'Phone', 'Developer', 1);
              }},
            ],
        });

        // HR
        panel.appendChild(document.createElement('hr'));

        var pManual = document.createElement('p');
        pManual.innerHTML = manUtils.getGlobalVars('loremLong');
        panel.appendChild(pManual);
      }

      function showBooks(panel) {
        document.getElementById('panel-header').innerHTML = 'หนังสือ (' + arrProducts.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var table = document.createElement('div');
        table.id = 'tabulator-books';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-books", {
            maxHeight:450,
            data:arrProducts, //set initial table data
            columns:[
              {title:"ใช้งาน", field:"Enable", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  onEditBook(cell.getRow().getData(), 'Enable', (cell.getRow().getData().Highlight == 'True') ? 'False' : 'True');
                }
              }},
              {title:"ออกใหม่", field:"Highlight", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  onEditBook(cell.getRow().getData(), 'Highlight', (cell.getRow().getData().Highlight == 'True') ? 'False' : 'True');
                }
              }},
              {title:"ขายดี", field:"BestSeller", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  onEditBook(cell.getRow().getData(), 'BestSeller', (cell.getRow().getData().BestSeller == 'True') ? 'False' : 'True');
                }
              }},
              {formatter:bookIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('shopURL') + '?id=' + cell.getRow().getData().ContactId + '&book=' + cell.getRow().getData().ProductId);
              }},
              {title:"ชื่อหนังสือ", width:280, field:"Title", headerFilter:"input"},
              {title:"ผู้เขียน", width:180, field:"Author", headerFilter:"input"},
              {title:"ขาย (เล่ม)", field:"Amount", hozAlign:"center"},
              {title:"ซื้อได้", field:"Available", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  onEditBook(cell.getRow().getData(), 'Available', (cell.getRow().getData().Available == 'True') ? 'False' : 'True');
                }
              }},
              {title:"เฉพาะบุคคล", field:"PrivateSale", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  onEditBook(cell.getRow().getData(), 'PrivateSale', (cell.getRow().getData().PrivateSale == 'True') ? 'False' : 'True');
                }
              }},
            ],
        });

        // HR
        panel.appendChild(document.createElement('hr'));
      }

      function showBookSpec(panel) {
        document.getElementById('panel-header').innerHTML = 'หนังสือ (' + arrProducts.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var table = document.createElement('div');
        table.id = 'tabulator-books';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-books", {
            maxHeight:450,
            data:arrProducts, //set initial table data
            columns:[
              /*
              {field:"Enable", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  onEditBookSpec(cell.getRow().getData(), 'Enable', (cell.getRow().getData().Enable == 'True') ? 'False' : 'True');
                }
              }},
              */
              {formatter:bookIcon, frozen:true, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('shopURL') + '?id=' + cell.getRow().getData().ContactId + '&book=' + cell.getRow().getData().ProductId);
              }},
              {title:"ชื่อหนังสือ", width:280, field:"Title", frozen:true},
              {title:"ผู้เขียน", width:180, field:"Author"},
              {title:"หนา", field:"Pages", editor:"input", cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Pages', cell.getValue());
              }},
              {title:"ขนาด", field:"Size", editor:"select", editorParams:{"B5":"B5", "A5":"A5", "A4":"A4", "Letter":"Letter", "Cover":"Cover"}, cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Size', cell.getValue());
              }},
              {title:"พิมพ์", field:"Printing", editor:"select", editorParams:{"ปกสี / เนื้อในสี":"ปกสี / เนื้อในสี", "ปกสี / เนื้อในขาวดำ":"ปกสี / เนื้อในขาวดำ", "ปกขาวดำ / เนื้อในขาวดำ":"ปกขาวดำ / เนื้อในขาวดำ"}, cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Printing', cell.getValue());
              }},
              {title:"กระดาษ", field:"Paper", editor:"select", editorParams:{"อาร์ต 260 แกรม / ปอนด์ 70 แกรม":"อาร์ต 260 แกรม / ปอนด์ 70 แกรม", "อาร์ต 260 แกรม / ถนอมสายตา 75 แกรม":"อาร์ต 260 แกรม / ถนอมสายตา 75 แกรม"}, cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Paper', cell.getValue());
              }},
              {title:"เข้าเล่ม", field:"Binding", editor:"select", editorParams:{"ไสกาว":"ไสกาว", "เย็บมุงหลังคา":"เย็บมุงหลังคา"}, cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Binding', cell.getValue());
              }},
              {title:"ปกหนังสือ", field:"Cover", editor:"select", editorParams:{"ปกเคลือบด้าน":"ปกเคลือบด้าน", "ปกเคลือบมัน":"ปกเคลือบมัน", "ไม่เคลือบ":"ไม่เคลือบ"}, cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Cover', cell.getValue());
              }},
              {title:"ระบบพิมพ์", field:"Production", editor:"select", editorParams:{"Digital print":"Digital print", "Offset print":"Offset print"}, cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Production', cell.getValue());
              }},
              {title:"ราคา", field:"Price", editor:"input", cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Price', cell.getValue());
              }},
              {title:"ค่าผลิต", field:"Cost", editor:"input", cellEdited:function(cell) {
                onEditBookSpec(cell.getRow().getData(), 'Cost', cell.getValue());
              }},
            ],
        });

        // HR
        panel.appendChild(document.createElement('hr'));
      }

      function showOrders(panel) {
        document.getElementById('panel-header').innerHTML = 'คำสั่งซื้อ (' + arrOrders.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var deck = document.createElement('div');
        deck.className = 'card-deck mb-3 text-center';
        panel.appendChild(deck);

        var incompleted = 0;
        var approval = 0;
        var awaiting = 0;

        for (var i in arrOrders) {
          if (arrOrders[i].OrderStatus == 'ป้อนข้อมูลจัดส่ง'
              || arrOrders[i].OrderStatus == 'รอการชำระเงิน') {
            incompleted++;
          }
          else if (arrOrders[i].OrderStatus == 'ชำระเงินแล้วรอตรวจสอบ') {
            approval++;
          }
          else if (arrOrders[i].OrderStatus == 'ชำระเงินเสร็จสมบูรณ์'
                   && arrOrders[i].TrackingCode == "") {
            awaiting++;
          }
        }

        // Payment Await
        var data = {
          ElementID: 'incompleted-order',
          Title: 'คำสั่งซื้อที่ไม่สมบูรณ์',
          Value: manUtils.formatNumber(incompleted, 0),
          Unit: 'รายการ',
          TextColor: 'white',
          Color: 'dark',
          Remark: 'คำสั่งซื้อที่อยู่ระหว่าง ป้อนข้อมูลจัดส่ง/รอการชำระเงิน',
        };
        spawnCard(deck, data);

        // Payment Approval
        var data = {
          ElementID: 'payment-approval',
          Title: 'รอยืนยันเงินโอน',
          Value: manUtils.formatNumber(approval, 0),
          Unit: 'รายการ',
          TextColor: 'white',
          Color: 'danger',
          Remark: 'ชำระเงินแล้ว รอการตรวจสอบและยืนยันการโอน',
        };
        spawnCard(deck, data);

        // Payment Approval
        var data = {
          ElementID: 'tracking-await',
          Title: 'รอการจัดส่งพัสดุ',
          Value: manUtils.formatNumber(awaiting, 0),
          Unit: 'รายการ',
          TextColor: 'white',
          Color: 'primary',
          Remark: 'ชำระเงินเสร็จสมบูรณ์ แต่ยังไม่มีเลขติดตามพัสดุ',
        };
        spawnCard(deck, data);

        var table = document.createElement('div');
        table.id = 'tabulator-orders';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-orders", {
            maxHeight:450,
            data:arrOrders, //set initial table data
            columns:[
              //{title:"วันที่สั่งซื้อ", width:100, field:"CreatedDate", headerFilter:"input"},
              {formatter:viewIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('checkoutURL') + "?id=" + cell.getRow().getData().OrderId);
              }},
              {title:"เลขที่คำสั่ง", width:120, field:"OrderId"},
              {title:"สถานะคำสั่ง", width:170, field:"OrderStatus", editor:"select", editorParams:{"ป้อนข้อมูลจัดส่ง":"ป้อนข้อมูลจัดส่ง", "รอการชำระเงิน":"รอการชำระเงิน", "ชำระเงินแล้วรอตรวจสอบ":"ชำระเงินแล้วรอตรวจสอบ", "ชำระเงินเสร็จสมบูรณ์":"ชำระเงินเสร็จสมบูรณ์"}, headerFilter:true, headerFilterParams:{"ป้อนข้อมูลจัดส่ง":"ป้อนข้อมูลจัดส่ง", "รอการชำระเงิน":"รอการชำระเงิน", "ชำระเงินแล้วรอตรวจสอบ":"ชำระเงินแล้วรอตรวจสอบ", "ชำระเงินเสร็จสมบูรณ์":"ชำระเงินเสร็จสมบูรณ์"}},
              {formatter:verifyIcon, hozAlign:"center", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')
                    || key == manUtils.getGlobalVars('keyAdmin')) {

                  if ((cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                      || (cell.getRow().getData().OrderStatus == 'ป้อนข้อมูลจัดส่ง' || cell.getRow().getData().OrderStatus == 'รอการชำระเงิน')) {

                  } else if (cell.getRow().getData().PaymentVerified == 0 && cell.getRow().getData().VerifyRejected == 0) {
                    onVerifyPayment(cell.getRow().getData().OrderId, cell.getRow().getData().GrandTotal, cell.getRow().getData().PaymentDate, cell.getRow().getData().PaymentTime, cell.getRow().getData().ShippingCost);
                  }
                }
              }},
              {formatter:rejectIcon, hozAlign:"center", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')
                    || key == manUtils.getGlobalVars('keyAdmin')) {

                  if ((cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                      || (cell.getRow().getData().OrderStatus == 'ป้อนข้อมูลจัดส่ง' || cell.getRow().getData().OrderStatus == 'รอการชำระเงิน')) {

                  } else if (cell.getRow().getData().PaymentVerified == 0 && cell.getRow().getData().VerifyRejected == 0) {
                    onRejectPayment(cell.getRow().getData().OrderId);
                  }
                }
              }},
              {title:"บ.", width:60, hozAlign:"right", field:"GrandTotal"},
              {title:"วันแจ้งโอน", width:100, hozAlign:"center", field:"PaymentDate", headerFilter:"input"},
              {hozAlign:"center", field:"PaymentTime"},
              {title:"", field:"PaymentVerified", hozAlign:"center", formatter:"tickCross"},
              {formatter:printIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('invoiceURL') + '?id=' + cell.getRow().getData().OrderId);
              }},
              {formatter:specIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('specURL') + '?id=' + cell.getRow().getData().OrderId);
              }},
              {title:"เลขที่พัสดุ", width:100, field:"TrackingCode", editor:"input", cellEdited:function(cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')
                    || key == manUtils.getGlobalVars('keyAdmin')) {

                  if (cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                    onInputTrackingId(cell.getRow().getData().OrderId, cell.getValue());
                  //else window.location.href = "admin.html?id=main-order&key=" + key;
                }
              }},
              {title:"ขนส่ง", width:80, field:"Transporter", editor:"select", editorParams:{"Flash":"Flash", "J&T":"J&T", "Kerry":"Kerry", "ThaiPost":"ThaiPost"}, cellEdited:function(cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')
                    || key == manUtils.getGlobalVars('keyAdmin')) {

                  if (cell.getRow().getData().OrderStatus == 'ชำระเงินเสร็จสมบูรณ์')
                    onSelectTransporter(cell.getRow().getData().OrderId, cell.getValue());
                }
              }},
              {formatter:trackingIcon, hozAlign:"center", cellClick:function(e, cell){
                var url = "";
                switch (cell.getRow().getData().Transporter) {
                  case 'Flash': url = manUtils.getGlobalVars('trackingFlash'); break;
                  case 'J&T': url = manUtils.getGlobalVars('trackingJ&T'); break;
                  case 'Kerry': url = manUtils.getGlobalVars('trackingKerry'); break;
                  case 'ThaiPost': url = manUtils.getGlobalVars('trackingThaiPost'); break;
                  default: url = "#"
                }
                window.open(url);
              }},
              {title:"แจ้ง", field:"Notified", hozAlign:"center", formatter:"tickCross", cellClick:function(e, cell){
                if (key == manUtils.getGlobalVars('keySuperAdmin')
                    || key == manUtils.getGlobalVars('keyPublisher')) {

                  swapOrderNotified(cell.getRow().getData().OrderId, (cell.getRow().getData().Notified == 1) ? 0 : 1);
                }
              }},
            ],
        });

        // HR
        panel.appendChild(document.createElement('hr'));
      }

      function showSales(panel) {
        document.getElementById('panel-header').innerHTML = 'รายการขาย (' + arrSales.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('loremShort');
        panel.appendChild(document.createElement('hr'));

        var table = document.createElement('div');
        table.id = 'tabulator-sales';
        panel.appendChild(table);

        var table = new Tabulator("#tabulator-sales", {
            maxHeight:450,
            data:arrSales, //set initial table data
            columns:[
              {title:"สถานะ", width:160, field:"PaymentStatus", editor:"select", editorParams:{"รอการชำระเงิน":"รอการชำระเงิน", "ชำระเงินเสร็จสมบูรณ์":"ชำระเงินเสร็จสมบูรณ์"}, headerFilter:true, headerFilterParams:{"รอการชำระเงิน":"รอการชำระเงิน", "ชำระเงินเสร็จสมบูรณ์":"ชำระเงินเสร็จสมบูรณ์"}},
              {formatter:viewIcon, hozAlign:"center", cellClick:function(e, cell){
                window.open(manUtils.getGlobalVars('checkoutURL') + "?id=" + cell.getRow().getData().OrderId);
              }},
              {title:"วันแจ้งโอน", width:100, hozAlign:"center", field:"PaymentDate", headerFilter:"input"},
              {title:"เวลา", hozAlign:"center", field:"PaymentTime"},
              {title:"ชื่อหนังสือ", width:250, field:"Title", headerFilter:"input"},
              {title:"ผู้เขียน", width:180, field:"Author", headerFilter:"input"},
              {title:"ซื้อ", width:60, field:"Amount", hozAlign:"center"},
              {title:"บ.", width:60, field:"Price", hozAlign:"right"},
              {title:"รวม", width:70, field:"SubTotal", hozAlign:"right"},
            ],
        });

        // HR
        panel.appendChild(document.createElement('hr'));
      }

      function showSidebarMenu(menuId) {
        document.getElementById('menu-website').href = manUtils.getGlobalVars('websiteURL');

        var topMenu = [];
        var menuItems = [];

        if (key == manUtils.getGlobalVars('keySuperAdmin')
            || key == manUtils.getGlobalVars('keyPublisher')
            || key == manUtils.getGlobalVars('keyViewer')) {
          menuItems.push({icon: 'fa-money', caption: 'การเงิน <span class="badge badge-danger">ฝ่ายการเงิน</span>', name: 'main-dashboard', href: 'admin.html?id=main-dashboard&key=' + key});
        }

        menuItems.push({icon: 'fa-user', caption: 'นักเขียน', name: 'main-contact', href: 'admin.html?id=main-contact&key=' + key});
        menuItems.push({icon: 'fa-book', caption: 'หนังสือ', name: 'main-book', href: 'admin.html?id=main-book&key=' + key});
        menuItems.push({icon: 'fa-clipboard-list', caption: 'สเปคหนังสือ', name: 'main-spec', href: 'admin.html?id=main-spec&key=' + key});
        menuItems.push({icon: 'fa-shopping-cart', caption: 'คำสั่งซื้อ', name: 'main-order', href: 'admin.html?id=main-order&key=' + key});
        menuItems.push({icon: 'fa-clipboard', caption: 'รายการขาย', name: 'main-sale', href: 'admin.html?id=main-sale&key=' + key});

        //console.log(key);
        var htmlTop = "";
        var html = "";
        if (menuItems.length > 0) {
          for (var i in menuItems) {
            var item = menuItems[i];

            var a = document.createElement('a');
            //a.className = (item.name == menuId) ? "nav-link active" : "nav-link";
            a.className = "btn btn-outline-light btn-sm";
            a.style = 'margin: 5px 5px 5px 5px;';
            a.href = item.href;
            a.innerHTML = item.caption;
            document.getElementById('menu-topbar').appendChild(a);

            html += '<li class="nav-item">';
              if (item.name == menuId)
                html += '<a class="nav-link active" href="' + item.href + '">';
              else html += '<a class="nav-link" href="' + item.href + '">';
                html += '<i class="fa ' + item.icon + ' fa-lg"></i>&nbsp;&nbsp;';
                html += item.caption;
                html += (item.name == menuId) ? '<span class="sr-only">(current)</span>' : '';
              html += '</a>';
            html += '</li>';
          }
          document.getElementById('menu-sidebar').innerHTML = html;
        }
      }

      function spawnCard(deck, data) {
        var html = '';

        html += '<div class="card mb-4 box-shadow">';
          html += '<div class="card-header text-' + data.TextColor + ' bg-' + data.Color + '">';
            html += '<h5 class="my-0 font-weight-normal">' + data.Title + '</h5>';
          html += '</div>';
          html += '<div class="card-body">';
            html += '<h1 class="card-title pricing-card-title"><span id="' + data.ElementID + '">' + data.Value + '</span> <small><small>' + data.Unit + '</small></small></h1>';
            html += '<p class="card-text"><small class="text-muted">' + data.Remark + '</small></p>';
          html += '</div>';
        html += '</div>';

        deck.innerHTML += html;
      }

      function spawnMediaObject(panel, data) {
        var media = document.createElement('div');
        media.className = "media";
        var img = document.createElement('img');
        img.className = "mr-3";
        img.src = data.imageURL;
        img.style = "max-width:" + data.maxWidth + 'px;';
        media.appendChild(img);
        var mediaBody = document.createElement('div');
        media.appendChild(mediaBody);
        var h = document.createElement('h5');
        h.className = "mt-0";
        h.innerHTML = data.Title;
        mediaBody.appendChild(h);
        var mediaText = document.createElement('div');
        mediaText.innerHTML = '<p>' + data.Description + '</p>';
        mediaBody.appendChild(mediaText);

        panel.appendChild(media);
      }

      window.addEventListener('load', (event) => {
        // GET GlobalVars
        fetch(sheetURL + '/tabs/GlobalVars')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          globalVars = myJson;

          init();
        })
        .catch((error) => { console.log(error); });
      });
    </script>
  </body>
</html>
