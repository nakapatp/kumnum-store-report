<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/favicon.ico">

    <title>ร้านหนังสือคำนำ - หน้ารายงาน</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/overlay.css" rel="stylesheet">
    <link href="css/dashboard.css" rel="stylesheet">
    <link href="css/pricing.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
  </head>

  <body>
    <div class="overlay" id="overlay"></div>

    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="https://www.kumnum.com">ร้านหนังสือคำนำ</a>
      <div class="topnav-right" id="menu-topbar">

      </div>
    </nav>

    <div class="container-fluid" id="container-main">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column" id="menu-sidebar">
              <!-- Dynamically load sidebar menu item -->
            </ul>
            <!--
            <hr>
            <ul class="nav flex-column mb-2">
              <li class="nav-item">
                <a class="nav-link" href="#" id="menu-website" target="_blank">
                  <i class="fa fa-globe fa-lg"></i>&nbsp;&nbsp;เว็บไซต์
                </a>
              </li>
            </ul>
            -->
          </div>
        </nav>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
          <div id="panel-content">
            <h3 id="panel-header"></h3>
            <p id="panel-description"></p>
          </div>
        </main>
      </div>

      <div id="modalEditProfile" class="modal fade" role="dialog">
        <div class="modal-dialog modal-sm">

          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="modal-title">แก้ไขข้อมูลส่วนตัว</h4>
            </div>
            <div class="modal-body">
              โทรศัพท์
              <input type="text" class="form-control" name="phone" id="phone">
              อีเมล
              <input type="text" class="form-control" name="email" id="email">
              ไลน์ไอดี
              <input type="text" class="form-control" name="lineId" id="lineId">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-light" data-dismiss="modal">ยกเลิก</button>
              <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="onEditContact()" >บันทึก</button>
            </div>
          </div>

        </div>
      </div>

    </div>
    <!-- 404 Page -->
    <div class="container" id="container-404">
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-slim.min.js"><\/script>')</script>
    <script src="js/popper.min.js"></script>
    <script src="js/holder.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>

    <!-- manUtils JavaScript -->
    <script src="js/manutils.js"></script>

    <!-- Font Awesome Kit Code -->
    <script src="https://kit.fontawesome.com/354ed2e7c0.js" crossorigin="anonymous"></script>


    <!-- Dashboard JavaScript -->
    <script type="text/javascript">
      const sheetURL = 'https://sheet.best/api/sheets/b195e9e6-e211-451d-8054-53bf717c89e6'; // Production (pnakapat)
      //const sheetURL = 'https://sheet.best/api/sheets/5acb1568-5ff2-4717-81dc-23a4093f6cbc'; // Production
      //const sheetURL = 'https://sheet.best/api/sheets/86299b5c-1850-4f51-b969-a44721bfe390'; // Dev
      var menuId = (manUtils.getParam('id') == null || manUtils.getParam('id') == "") ? 'main-dashboard' : manUtils.getParam('id');
      var key = manUtils.getParam('key');
      var globalVars = null;
      var keyOwner = null;
      var arrProducts = null;
      var arrSales = null;
      var arrPayments = null;

      function showPage404() {
        document.getElementById('container-main').style.display = 'none';
        var desc = 'การเรียกดูรายงานการขายต้องใช้ <span class="text-primary"><i class="fa fa-key"></i> รหัสส่วนตัว</span> ในอีเมลที่คุณได้รับคำยืนยันการลงทะเบียนสำเร็จจากสำนักพิมพ์<br/>';
        desc += 'โปรดตรวจสอบข้อมูลจากอีเมลดังกล่าวอีกครั้ง หรือ<br/>';
        desc += 'หากยังไม่ได้รับอีเมลยืนยัน กรุณาติดต่อเจ้าหน้าที่ของ "คำนำ" ที่ดูแลคุณอยู่';
        document.getElementById('container-404').innerHTML = manUtils.getHTML404('ขออภัย!', 'เราไม่พบข้อมูลที่คุณกำลังมองหา', desc);
        document.getElementById('overlay').remove();
      }

      function formatSpec(obj) {
        var str = "";
        str += 'ขนาด: ' + obj.Size + '<br>';
        str += 'หนา: ' + obj.Pages + ' หน้า<br>';
        str += 'พิมพ์: ' + obj.Printing + '<br>';
        str += 'กระดาษ: ' + obj.Paper + '<br>';
        str += 'เข้าเล่ม: ' + obj.Binding + '<br>';
        str += 'ปกหนังสือ: ' + obj.Cover + '<br>';
        str += 'ระบบการพิมพ์: ' + obj.Production;
        return str;
      }

      function getPublicShopURL(contactId) {
        return manUtils.getGlobalVars('shopURL') + '?id=' + contactId;
      }

      function getPublicShopQRCode(contactId) {
        return manUtils.getGlobalVars('qrCodeURL') + '?id=' + contactId;
      }

      function getPrivateBookURL(contactId, productId) {
        return manUtils.getGlobalVars('shopURL') + '?id=' + contactId + '&book=' + productId;
      }

      function getPrivateBookQRCode(contactId, productId) {
        return manUtils.getGlobalVars('qrCodeURL') + '?id=' + contactId + '&book=' + productId;
      }

      function init() {

        showSidebarMenu(menuId);

        // Show Panel Content
        var iPanel = document.getElementById('panel-content');
        switch (menuId) {
          case 'main-dashboard': showDashboard(iPanel); break;
          case 'main-profile': showProfile(iPanel); break;
          case 'main-shop': showShop(iPanel); break;
          case 'main-book': showBook(iPanel); break;
          default:
        }
        document.getElementById('overlay').remove();
      }

      function disableScreen() {
        var div= document.createElement("div");
        div.className += "overlay";
        document.body.appendChild(div);
      }

      function onEditContact() {
        disableScreen();

        fetch(sheetURL + '/tabs/Contacts/ContactId/*' + keyOwner.ContactId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              Phone: document.getElementById('phone').value,
              Email: document.getElementById('email').value,
              LineId: document.getElementById('lineId').value,
            }),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          //console.log(phone + ', ' + email);
          window.location.href = "index.html?id=main-profile";
        })
        .catch((error) => { console.log(error); });
      }

      function loadContactsByKey(keyId) {
        // GET Author Info
        fetch(sheetURL + '/tabs/Contacts/SecretKey/*' + keyId + '*')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          keyOwner = myJson[0];

          if (manUtils.getCookie("username") == keyOwner.Email
              && manUtils.getCookie("password") == keyOwner.SecretKey) {

            loadPayments(keyOwner.ContactId);
          //} else if (keyOwner == null
          //      || key == null || key == '' || key == 0) {
              //showPage404();
          //    window.location.href = "login.html";

          //} else
          } else {
            window.location.href = "login.html";
          }
        })
        .catch((error) => { console.log(error); });
      }

      function loadPayments(contactId) {
        // GET Author Payments
        fetch(sheetURL + '/tabs/Payments/ContactId/*' + contactId + '*')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          arrPayments = myJson;

          if (menuId == 'main-dashboard'
              || menuId == 'main-book' ) {
            loadProducts(contactId);
          } else {
            init();
          }
        })
        .catch((error) => { console.log(error); });
      }

      function loadProducts(contactId) {
        // GET Author's Collections
        fetch(sheetURL + '/tabs/Products/ContactId/*' + contactId + '*')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrProducts = myJson;

          loadSales(contactId);
        })
        .catch((error) => { console.log(error); });
      }

      function loadSales(contactId) {
        // GET Author's Collections
        fetch(sheetURL + '/tabs/Sales/ContactId/*' + contactId + '*')
        .then((response) => {
            return response.json();
        })
        .then((myJson) => {
          arrSales = myJson;

          // Reconcile [Contacts] SaleCount, ShareReceived, ShareAwait
          // Reconcile [Products] Amount, CopyrightShare
          var count = 0;
          var received = 0;
          var pending = 0;

          // Reset to ZERO.
          for (var i in arrProducts) {
            setProductSales(arrProducts[i].ProductId, 0, true);
          }
          // Collective Sales
          for (var i in arrSales) {
            if (arrSales[i].PaymentStatus == 'ชำระเงินเสร็จสมบูรณ์') {
              count += Number(arrSales[i].Amount);
              pending += Number(arrSales[i].CopyrightShare)
              setProductSales(arrSales[i].ProductId, arrSales[i].Amount, false);
            }
          }
          if (arrPayments.length > 0) {
            // Collective Income.
            for (var i in arrPayments) {
             received += Number(arrPayments[i].Outcome);
            }
          }
          // Push Collective Product Values to DB.
          for (var i in arrProducts) {
            arrProducts[i].CopyrightShare = arrProducts[i].Amount * arrProducts[i].SharePerUnit;
            patchProductSales(arrProducts[i], arrProducts[i].Amount);
          }

          var wait = pending - received;
          //console.log("pending: " + pending);
          //console.log("received: " + received);
          fetch(sheetURL + '/tabs/Contacts/ContactId/*' + contactId + '*', {
            method: "PATCH",
            mode: "cors",
            headers: {
             "Content-Type": "application/json",
            },
            body: JSON.stringify({
             SaleCount: (count == 0) ? "0" : count,
             ShareReceived: (received == 0) ? "0" : received,
             ShareAwait: (wait == 0) ? "0" : wait,
            }),
          })
          .then((response) => { return response.json(); })
          .then((myJson) => {
            keyOwner.SaleCount = count;
            keyOwner.ShareReceived = received;
            keyOwner.ShareAwait = (wait == 0) ? "0" : wait;

            init();
          })
          .catch((error) => { console.log(error); });
        })
        .catch((error) => { console.log(error); });
      }

      function setProductSales(productId, amount, reset) {
        for (var i in arrProducts) {
          if (arrProducts[i].ProductId == productId) {
            if (reset)
              arrProducts[i].Amount = amount;
            else arrProducts[i].Amount += Number(amount);
            break;
          }
        }
      }

      function patchProductSales(product, amount) {
        var share = amount * product.SharePerUnit;

        fetch(sheetURL + '/tabs/Products/ProductId/*' + product.ProductId + '*', {
          method: "PATCH",
          mode: "cors",
          headers: {
           "Content-Type": "application/json",
          },
          body: JSON.stringify({
           Amount: (amount == 0) ? "0" : amount,
           CopyrightShare: (share == 0) ? "0" : share,
          }),
        })
        .then((response) => { return response.json(); })
        .then((myJson) => {

        })
        .catch((error) => { console.log(error); });
      }

      function showDashboard(panel) {
        // Copyright Share Report
        document.getElementById('panel-header').innerHTML = 'รายงานสรุปการจัดจำหน่าย';
        document.getElementById('panel-description').innerHTML = 'หนังสือของ ' + manUtils.formatName(keyOwner.Title, keyOwner.FirstName, keyOwner.LastName);
        //panel.appendChild(document.createElement('hr'));

        var deck = document.createElement('div');
        deck.className = 'card-deck mb-3 text-center';
        panel.appendChild(deck);

        // Sales
        var data = {
          ElementID: 'collective-sales',
          Title: 'ยอดจำหน่ายสะสม',
          Value: manUtils.formatNumber(keyOwner.SaleCount, 0),
          Unit: 'เล่ม',
          Description: manUtils.getGlobalVars('loremShort'),
          Image: 'https://i.imgur.com/Ujp4WxW.jpg',
          Width: 120,
          TextColor: 'white',
          Color: 'primary',
          Remark: 'นับเฉพาะรายการที่ชำระเงินเสร็จสมบูรณ์',
        };
        spawnCard(deck, data);

        // Transferred Share
        var data = {
          ElementID: 'transferred-share',
          Title: 'ค่าลิขสิทธิ์รับแล้ว',
          Value: manUtils.formatNumber(keyOwner.ShareReceived, 0),
          Unit: 'บาท',
          Description: manUtils.getGlobalVars('loremShort'),
          Image: 'https://i.imgur.com/Ujp4WxW.jpg',
          Width: 120,
          TextColor: 'white',
          Color: 'success',
          Remark: 'ดูรายการรับโอนค่าลิขสิทธิ์ได้ที่ <i class="fa fa-book"></i> ข้อมูลส่วนตัว',
        };
        spawnCard(deck, data);

        // Coming Share
        var data = {
          ElementID: 'coming-share',
          Title: 'ค่าลิขสิทธิ์รอรับ',
          Value: manUtils.formatNumber(keyOwner.ShareAwait, 0),
          Unit: 'บาท',
          Description: manUtils.getGlobalVars('loremShort'),
          Image: 'https://i.imgur.com/Ujp4WxW.jpg',
          Width: 120,
          TextColor: 'black',
          Color: 'warning',
          Remark: 'รอบรับครั้งต่อไปวันที่ ' + manUtils.formatDateThai(keyOwner.NextPaid),
        };
        spawnCard(deck, data);

        // Table of Sale Summary
        appendTableSaleSummary(panel);

        // Chart
        //appendChart(panel);

        // Table of Latest Sales
        //panel.appendChild(document.createElement('hr'));
        appendTableLatestSale(panel);

        // HR
        panel.appendChild(document.createElement('hr'));
      }

      function appendTableSaleSummary(panel) {
        // Table of Sales Summary
        var hTableSum = document.createElement('h3');
        hTableSum.innerHTML = 'สรุปแบบรายเล่ม';
        panel.appendChild(hTableSum);

        var pTableSum = document.createElement('p');
        pTableSum.innerHTML = manUtils.getGlobalVars('guideTableSaleSummary');
        panel.appendChild(pTableSum);

        var tableSum = document.createElement('table');
        tableSum.className = 'table table-sm';
        panel.appendChild(tableSum);

        var html = '<thead><tr class="bg-light">'
          html += '<th class="text-center" scope="col">#</th>';
          html += '<th class="text-center" scope="col">ขายวันแรก</th>';
          html += '<th scope="col">ชื่อหนังสือ</th>';
          html += '<th class="text-center" scope="col">ยอดจำหน่าย (เล่ม)</th>';
          html += '<th class="text-right" scope="col">ราคาปก (บ.)</th>';
          html += '<th class="text-right" scope="col">ค่าลิขสิทธิ์ต่อเล่ม (บ.)</th>';
          html += '<th class="text-right" scope="col">ส่วนแบ่งรายได้ (บ.)</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        var sumSales = 0;
        var sumShare = 0;
        for (var i in arrProducts) {
          html += '<tr>';
            html += '<td class="text-center" scope="row">' + Number(Number(i) + 1) +'</td>';
            html += '<td class="text-center">' + manUtils.formatDateThai(arrProducts[i].CreatedDate, true) + '</td>';
            html += '<td>' + arrProducts[i].Title + '</td>';
            html += '<td class="text-center">' + arrProducts[i].Amount + '</td>';
            html += '<td class="text-right">' + arrProducts[i].Price + '</td>';
            html += '<td class="text-right">' + arrProducts[i].SharePerUnit + '</td>';
            html += '<td class="text-right">' + manUtils.formatNumber(arrProducts[i].CopyrightShare, 0) + '</td>';
          html += '</tr>';
          sumSales += Number(arrProducts[i].Amount);
          sumShare += Number(arrProducts[i].CopyrightShare);
        }
        //document.getElementById('collective-sales').innerHTML = manUtils.formatNumber(sumSales, 0);
        //document.getElementById('coming-share').innerHTML = manUtils.formatNumber(sumShare, 0);
        // Total Row
        html += '<tr>';
          html += '<td class="text-center" scope="row"></td>';
          html += '<td class="text-center"></td>';
          html += '<td><h4>รวม</h4></td>';
          html += '<td class="text-center"><h4>' + manUtils.formatNumber(sumSales, 0) + '</h4></td>';
          html += '<td class="text-right"></td>';
          html += '<td class="text-right"></td>';
          html += '<td class="text-right"><h4>' + manUtils.formatNumber(sumShare, 0) + '</h4></td>';
        html += '</tr>';
        html += '<tr>';
          html += '<td class="text-center" scope="row"></td>';
          html += '<td class="text-center"></td>';
          html += '<td></td>';
          html += '<td class="text-center"></td>';
          html += '<td class="text-right"></td>';
          html += '<td class="text-right"></td>';
          html += '<td class="text-right"></td>';
        html += '</tr>';
        html += '</tbody>'
        tableSum.innerHTML = html;
      }

      function appendChart(panel) {
        // Chart Sale Summary
        var hChart = document.createElement('h3');
        hChart.innerHTML = 'สรุปตามช่วงเวลา';
        panel.appendChild(hChart);

        var divPeriod = document.createElement('div');
        divPeriod.className = 'btn-toolbar mb-2 mb-md-0';
        var html = "";
        html += '<div class="btn-group mr-2">';
          html += '<button class="btn btn-sm btn-outline-secondary">สัปดาห์นี้</button>';
          html += '<button class="btn btn-sm btn-outline-secondary">เดือนนี้</button>';
          html += '<button class="btn btn-sm btn-outline-secondary">ปีนี้</button>';
          html += '<button class="btn btn-sm btn-outline-secondary">ปีก่อน</button>';
        html += '</div>';
        divPeriod.innerHTML = html;
        panel.appendChild(divPeriod);

        var canvas = document.createElement('canvas');
        canvas.height = "100";
        panel.appendChild(canvas);
        var ctx = canvas.getContext('2d');

        'use strict';

        window.chartColors = {
          red: 'rgb(255, 99, 132)',
          orange: 'rgb(255, 159, 64)',
          yellow: 'rgb(255, 205, 86)',
          green: 'rgb(75, 192, 192)',
          blue: 'rgb(54, 162, 235)',
          purple: 'rgb(153, 102, 255)',
          grey: 'rgb(201, 203, 207)'
        };

        window.randomScalingFactor = function() {
          return (Math.random() > 0.5 ? 1.0 : -1.0) * Math.random() * 100;
        };

    		var lineChartData = {
    			labels: ['1 สัปดาห์ก่อน', '6 วันก่อน', '5 วันก่อน', '4 วันก่อน', '3 วันก่อน', 'เมื่อวาน', 'วันนี้'],
    			datasets: [{
    				label: 'เล่ม #1',
    				borderColor: window.chartColors.red,
    				backgroundColor: window.chartColors.red,
    				fill: false,
    				data: [
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor()
    				],
    				yAxisID: 'y-axis-1',
    			}, {
    				label: 'เล่ม #2',
    				borderColor: window.chartColors.green,
    				backgroundColor: window.chartColors.green,
    				fill: false,
    				data: [
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor()
    				],
    				yAxisID: 'y-axis-2'
    			}, {
    				label: 'เล่ม #3',
    				borderColor: window.chartColors.blue,
    				backgroundColor: window.chartColors.blue,
    				fill: false,
    				data: [
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor(),
    					randomScalingFactor()
    				],
    				yAxisID: 'y-axis-3'
    			}]
    		};

        window.myLine = Chart.Line(ctx, {
          data: lineChartData,
          options: {
            responsive: true,
            hoverMode: 'index',
            stacked: false,
            title: {
              display: true,
              text: manUtils.getGlobalVars('guideSaleSummary'),
            },
            scales: {
              yAxes: [{
                type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                display: true,
                position: 'left',
                id: 'y-axis-1',
              }, {
                type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                display: false,
                position: 'left',
                id: 'y-axis-2',
              }, {
                type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                display: true,
                position: 'right',
                id: 'y-axis-3',

                // grid line settings
                gridLines: {
                  drawOnChartArea: false, // only want the grid lines for one axis to show up
                },
              }],
            }
          }
        });
      }

      function appendTableLatestSale(panel) {
        var hTable = document.createElement('h3');
        hTable.innerHTML = 'รายการจำหน่ายล่าสุด';
        panel.appendChild(hTable);

        var pTable = document.createElement('p');
        pTable.innerHTML = manUtils.getGlobalVars('guideLatestSale').replace('[Number]', manUtils.getGlobalVars('latestSaleNum'));
        panel.appendChild(pTable);

        var table = document.createElement('table');
        table.className = 'table table-sm';
        panel.appendChild(table);

        var html = '<thead><tr class="bg-light">'
          html += '<th class="text-center" scope="col">เลขอ้างอิง</th>';
          html += '<th class="text-center" scope="col">วันที่</th>';
          html += '<th scope="col">ชื่อหนังสือ</th>';
          html += '<th class="text-center" scope="col">ยอดจำหน่าย (เล่ม)</th>';
          html += '<th class="text-right" scope="col">ราคาปก (บ.)</th>';
          html += '<th class="text-right" scope="col">มูลค่าการขาย (บ.)</th>';
          html += '<th class="text-right" scope="col">ส่วนแบ่งรายได้ (บ.)</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        var n = 0;
        for (var i in arrSales) {
          if (arrSales[i].PaymentDate) {
            html += '<tr>';
              html += '<td class="text-center" scope="row">' + Number(Number(i) + 1) +'</td>';
              html += '<td class="text-center">' + manUtils.formatDateThai(arrSales[i].PaymentDate) + '</td>';
              html += '<td>' + arrSales[i].Title + '</td>';
              html += '<td class="text-center">' + arrSales[i].Amount + '</td>';
              html += '<td class="text-right">' + arrSales[i].Price + '</td>';
              html += '<td class="text-right">' + manUtils.formatNumber(arrSales[i].SubTotal, 0) + '</td>';
              html += '<td class="text-right">' + manUtils.formatNumber(arrSales[i].CopyrightShare, 0) + '</td>';
            html += '</tr>';
            if (++n >= manUtils.getGlobalVars('latestSaleNum'))
              break;
          }
        }
        html += '</tbody>'
        table.innerHTML = html;
      }

      function appendTableOfPayment(panel) {
        var hTable = document.createElement('h3');
        hTable.innerHTML = 'รายการรับโอนค่าลิขสิทธิ์';
        panel.appendChild(hTable);

        var pTable = document.createElement('p');
        pTable.innerHTML = manUtils.getGlobalVars('guidePayment').replace('[Number]', keyOwner.BillPeriod);
        panel.appendChild(pTable);

        var table = document.createElement('table');
        table.className = 'table table-sm';
        panel.appendChild(table);

        var html = '<thead><tr class="bg-light">'
          html += '<th class="text-center" scope="col">#</th>';
          html += '<th class="text-center" scope="col">วันที่</th>';
          html += '<th class="text-center" scope="col">เวลา</th>';
          html += '<th class="text-right" scope="col">จำนวนเงิน</th>';
          html += '<th class="text-center" scope="col">รายการ</th>';
          html += '<th class="text-center" scope="col">เลขที่บัญชีโอนเข้า</th>';
          html += '<th class="text-center" scope="col">ชื่อธนาคาร</th>';
          //html += '<th class="text-center" scope="col">ภาพสลิปโอน</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        var share = 0;
        for (var i in arrPayments) {
          if (arrPayments[i].Canceled != 1) {
            html += '<tr>';
              html += '<td class="text-center" scope="row">' + Number(Number(i) + 1) +'</td>';
              html += '<td class="text-center">' + manUtils.formatDateThai(arrPayments[i].PaymentDate) + '</td>';
              html += '<td class="text-center">' + arrPayments[i].PaymentTime + '</td>';
              html += '<td class="text-right">' + manUtils.formatNumber(arrPayments[i].Outcome, 0) + '</td>';
              html += '<td class="text-center">' + arrPayments[i].Content + '</td>';
              html += '<td class="text-center">' + arrPayments[i].BankAccountId + '</td>';
              html += '<td class="text-center">' + arrPayments[i].BankName + '</td>';
            html += '</tr>';
            share += Number(arrPayments[i].Outcome);
          }
        }
        // Summary Row
        html += '<tr>';
          html += '<td class="text-center" scope="row"></td>';
          html += '<td class="text-center"><h4>รวม</h4></td>';
          html += '<td class="text-center"></td>';
          html += '<td class="text-right"><h4>' + manUtils.formatNumber(share, 0) + '</h4></td>';
          html += '<td class="text-center"></td>';
          html += '<td class="text-center"></td>';
          html += '<td class="text-center"></td>';
          html += '<td class="text-center"></td>';
        html += '</tr>';

        html += '</tbody>'
        table.innerHTML = html;
      }

      function showProfile(panel) {
        document.getElementById('panel-header').innerHTML = 'ข้อมูลส่วนตัว';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('guideProfile');
        panel.appendChild(document.createElement('hr'));

        if (keyOwner) {
          document.getElementById('phone').value = manUtils.formatPhoneNumber(keyOwner.Phone);
          document.getElementById('email').value = keyOwner.Email;
          document.getElementById('lineId').value = keyOwner.LineId;

          var data = {
            Title: manUtils.formatName(keyOwner.Title, keyOwner.FirstName, keyOwner.LastName),
            Description: keyOwner.Biography,
            imageURL: keyOwner.ImageProfile,
            maxWidth: 220,
          };

          var html = '';
          html += '<ul class="list-group">';
            html += '<li class="list-group-item"><i class="fa fa-phone fa-lg"></i>&nbsp;&nbsp;' + keyOwner.Phone + ' <div class="badge badge-danger">งดเผยแพร่</div>&nbsp;&nbsp;<a data-toggle="modal" data-target="#modalEditProfile"><i class="fa fa-pencil"></i></a></li>';
            html += '<li class="list-group-item"><i class="fa fa-envelope fa-lg"></i>&nbsp;&nbsp;' + keyOwner.Email + ' <div class="badge badge-success">เผยแพร่</div>&nbsp;&nbsp;<a data-toggle="modal" data-target="#modalEditProfile"><i class="fa fa-pencil"></i></a></li>';
            if (keyOwner.LineId) html += '<li class="list-group-item"><i class="fab fa-line fa-lg"></i>&nbsp;&nbsp;' + keyOwner.LineId + ' <div class="badge badge-success">เผยแพร่</div>&nbsp;&nbsp;<a data-toggle="modal" data-target="#modalEditProfile"><i class="fa fa-pencil"></i></a></li>';
            html += '<li class="list-group-item"><i class="fa fa-money fa-lg"></i>&nbsp;&nbsp;' + keyOwner.BankAccountId + '&nbsp;&nbsp;' + keyOwner.BankName + ' <div class="badge badge-danger">งดเผยแพร่</div></li>';
            html += '<li class="list-group-item"><i class="fa fa-calendar fa-lg"></i>&nbsp;&nbsp;รับส่วนแบ่งค่าลิขสิทธิ์ทุก ' + keyOwner.BillPeriod + ' เดือน</li>';
          html += '</ul>';
          data.Description += html;
          spawnMediaObject(panel, data);

          // HR
          panel.appendChild(document.createElement('hr'));

          appendTableOfPayment(panel);

          // HR
          panel.appendChild(document.createElement('hr'));
        }
      }

      function showShop(panel) {
        document.getElementById('panel-header').innerHTML = 'ร้านหนังสือ';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('guideShop');
        panel.appendChild(document.createElement('hr'));

        if (keyOwner) {
          var data = {
            Title: "",
            Description: manUtils.getGlobalVars('guidePublicShop'),
            imageURL: "https://i.imgur.com/M1VpvIz.png",
            maxWidth: 200,
          };
          data.Title += ' <div class="badge badge-success">ขายแบบสาธารณะ</div>';

          var html = '';
          html += '<p><ul class="list-group">';
            html += '<li class="list-group-item"><i class="fa fa-globe fa-lg"></i>&nbsp;&nbsp;ลิงก์&nbsp;&nbsp;<a href="' + getPublicShopURL(keyOwner.ContactId) + '" target="_blank">' + getPublicShopURL(keyOwner.ContactId) + '</a></li>';
            html += '<li class="list-group-item"><i class="fa fa-qrcode fa-lg"></i>&nbsp;&nbsp;<a href="' + getPublicShopQRCode(keyOwner.ContactId) + '" target="_blank">ภาพคิวอาร์โค้ด</a></li>';
          html += '</ul></p>';
          data.Description += html;
          spawnMediaObject(panel, data);

          // HR
          panel.appendChild(document.createElement('hr'));

          var data = {
            Title: "",
            Description: manUtils.getGlobalVars('guidePrivateSale'),
            imageURL: "https://i.imgur.com/pubpU8F.png",
            maxWidth: 220,
          };
          data.Title += ' <div class="badge badge-warning">ขายเฉพาะบุคคล</div>';
          spawnMediaObject(panel, data);

          // HR
          panel.appendChild(document.createElement('hr'));

          var data = {
            Title: "",
            Description: manUtils.getGlobalVars('guideNotAvailable'),
            imageURL: "https://i.imgur.com/LUWRY8i.png",
            maxWidth: 220,
          };
          data.Title += ' <div class="badge badge-danger">งดจำหน่าย</div>';
          spawnMediaObject(panel, data);
        }
      }

      function showBook(panel) {
        document.getElementById('panel-header').innerHTML = 'หนังสือ (' + arrProducts.length + ')';
        document.getElementById('panel-description').innerHTML = manUtils.getGlobalVars('guideBook');
        panel.appendChild(document.createElement('hr'));

        if (keyOwner && arrProducts) {

          var html = '';
          for (var i in arrProducts) {
            //var desc = arrProducts[i].Brief;
            //desc += '<p style="color:#ccc; font-weight:300">' + arrProducts[i].Spec + '</p>';
            var data = {
              Title: arrProducts[i].Title,
              Description: arrProducts[i].Brief,
              imageURL: arrProducts[i].ImageFull,
              maxWidth: 170,
            };
            if (arrProducts[i].Available == 'False')
              data.Title += ' <div class="badge badge-danger">งดจำหน่าย</div>';
            else {
              data.Title += (arrProducts[i].PrivateSale == 'True')
                   ? ' <div class="badge badge-warning">ขายเฉพาะบุคคล</div>'
                   : ' <div class="badge badge-success">ขายแบบสาธารณะ</div>';
            }
            var tooltiptext = '';
            html = '<h4>' + arrProducts[i].Price + ' บ.';
              tooltiptext = formatSpec(arrProducts[i]).replaceAll('<br>', '&#10');
              html += '<span class="text-secondary"> <small><i class="fa fa-info-circle fa-xs" data-toggle="tooltip" data-placement="top" title="' + tooltiptext + '"></i></small></span>';
            html += '</h4>';
            html += '<p>';
              html += '<span>ค่าลิขสิทธิ์ ' + arrProducts[i].SharePerUnit + ' บ.';
              tooltiptext = '';
              tooltiptext += 'ค่าผลิต ' + arrProducts[i].Cost + ' บ.';
              tooltiptext += '&#10ค่าจัดจำหน่าย ' + (Number(arrProducts[i].PublisherShare) + Number(arrProducts[i].PlatformShare)) + ' บ.';
              tooltiptext += '&#10ค่าลิขสิทธิ์ ' + arrProducts[i].SharePerUnit + ' บ. (' + arrProducts[i].CopyrightRatio + '%)';
              html += '<span class="text-secondary"> <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="top" title="' + tooltiptext + '"></i>'
              //html += ' ค่าผลิต (' + arrProducts[i].Cost + ' บ.) ค่าจัดจำหน่าย (' + (Number(arrProducts[i].PublisherShare) + Number(arrProducts[i].PlatformShare)) + ' บ.)';
            html += '</p>';
            html += '<p><ul class="list-group">';
              html += '<li class="list-group-item"><i class="fa fa-globe fa-lg"></i>&nbsp;&nbsp;ลิงก์สั่งซื้อ&nbsp;&nbsp;<a href="' + getPrivateBookURL(arrProducts[i].ContactId, arrProducts[i].ProductId) + '" target="_blank">' + getPrivateBookURL(arrProducts[i].ContactId, arrProducts[i].ProductId) + '</a></li>';
              html += '<li class="list-group-item"><i class="fa fa-qrcode fa-lg"></i>&nbsp;&nbsp;<a href="' + getPrivateBookQRCode(arrProducts[i].ContactId, arrProducts[i].ProductId) + '" target="_blank">ภาพคิวอาร์โค้ด</a></li>';
            html += '</ul></p>';
            data.Description += html;
            spawnMediaObject(panel, data);

            // HR
            panel.appendChild(document.createElement('hr'));
          }
        }
      }

      function showSidebarMenu(menuId) {
        //document.getElementById('menu-website').href = manUtils.getGlobalVars('websiteURL');

        var menuItems = [
          {icon: 'fa-money', caption: 'รายงานสรุป', name: 'main-dashboard', href: 'index.html?id=main-dashboard'},
          {icon: 'fa-user', caption: 'ข้อมูลส่วนตัว', name: 'main-profile', href: 'index.html?id=main-profile'},
          {icon: 'fa-shopping-cart', caption: 'ร้านหนังสือ', name: 'main-shop', href: 'index.html?id=main-shop'},
          {icon: 'fa-book', caption: 'หนังสือ', name: 'main-book', href: 'index.html?id=main-book'},
          {icon: 'fa-globe', caption: 'เว็บไซต์', name: 'main-website', href: manUtils.getGlobalVars('websiteURL')},
          {icon: 'fa-sign-out-alt', caption: 'ออกจากระบบ', name: 'main-logout', href:'login.html?signout=1'},
        ];
        var html = "";

        for (var i in menuItems) {
          var item = menuItems[i];

          var a = document.createElement('a');
          //a.className = (item.name == menuId) ? "nav-link active" : "nav-link";
          a.className = "btn btn-outline-light btn-sm";
          a.style = 'margin: 5px 5px 5px 5px;';
          a.href = item.href;
          a.innerHTML = item.caption;
          document.getElementById('menu-topbar').appendChild(a);

          html += '<li class="nav-item">';
            if (item.name == menuId)
              html += '<a class="nav-link active" href="' + item.href + '">';
            else html += '<a class="nav-link" href="' + item.href + '">';
              html += '<i class="fa ' + item.icon + ' fa-lg"></i>&nbsp;&nbsp;';
              html += item.caption;
              html += (item.name == menuId) ? '<span class="sr-only">(current)</span>' : '';
            html += '</a>';
          html += '</li>';
        }
        document.getElementById('menu-sidebar').innerHTML = html;
      }

      function spawnCard(deck, data) {
        var html = '';

        html += '<div class="card mb-4 box-shadow">';
          html += '<div class="card-header text-' + data.TextColor + ' bg-' + data.Color + '">';
            html += '<h5 class="my-0 font-weight-normal">' + data.Title + '</h5>';
          html += '</div>';
          html += '<div class="card-body">';
            html += '<h1 class="card-title pricing-card-title"><span id="' + data.ElementID + '">' + data.Value + '</span> <small><small>' + data.Unit + '</small></small></h1>';
            //html += '<p class="card-text">' + data.Description + '</p>';
            html += '<p class="card-text"><small class="text-muted">' + data.Remark + '</small></p>';
          html += '</div>';
        html += '</div>';

        deck.innerHTML += html;
      }

      function spawnMediaObject(panel, data) {
        var media = document.createElement('div');
        media.className = "media";
        var img = document.createElement('img');
        //img.id = "qrcode-shop";
        img.className = "mr-3";
        img.src = data.imageURL;
        img.style = "max-width:" + data.maxWidth + 'px;';
        media.appendChild(img);
        var mediaBody = document.createElement('div');
        media.appendChild(mediaBody);
        var h = document.createElement('h5');
        h.className = "mt-0";
        h.innerHTML = data.Title;
        mediaBody.appendChild(h);
        var mediaText = document.createElement('div');
        mediaText.innerHTML = '<p>' + data.Description + '</p>';
        mediaBody.appendChild(mediaText);

        panel.appendChild(media);
      }

      window.addEventListener('load', (event) => {
        // GET GlobalVars
        // -- GET Author Info
        fetch(sheetURL + '/tabs/GlobalVars')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          globalVars = myJson;

          //loadContactsByKey(manUtils.decryptKey(key));
          loadContactsByKey(manUtils.getCookie("password"));
        })
        .catch((error) => { console.log(error); });
      });
    </script>
  </body>
</html>
